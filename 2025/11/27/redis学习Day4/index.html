<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="chenjunda"><meta name="renderer" content="webkit"><meta name="copyright" content="chenjunda"><meta name="keywords" content="é™ˆå°è¾¾çš„ä¸ªäººåšå®¢"><meta name="description" content="å­¦ä¹ ç¬”è®°"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>rediså­¦ä¹ Day4 Â· é™ˆå°è¾¾çš„åšå®¢</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/cat.png"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">chenjunda</div><div class="profile-signature">é•¿æœŸä¸»ä¹‰</div><div class="friends"><div>FRIENDS</div><span><a href="//github.com/Longlongyu" target="_black">friendA</a></span><span><a href="//github.com/" target="_black">friendB</a></span><span><a href="//github.com/" target="_black">friendC</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">é™ˆå°è¾¾çš„åšå®¢</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">rediså­¦ä¹ Day4</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2025-11-27</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="redis"> redis</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="ä½¿ç”¨redisä¸­çš„streamåˆ—è¡¨å½“æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥ä¸‹å•"><a href="#ä½¿ç”¨redisä¸­çš„streamåˆ—è¡¨å½“æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥ä¸‹å•" class="headerlink" title="ä½¿ç”¨redisä¸­çš„streamåˆ—è¡¨å½“æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥ä¸‹å•"></a>ä½¿ç”¨redisä¸­çš„streamåˆ—è¡¨å½“æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥ä¸‹å•</h1><h2 id="1-çº¿ç¨‹æ± ä¸åå°çº¿ç¨‹åˆå§‹åŒ–"><a href="#1-çº¿ç¨‹æ± ä¸åå°çº¿ç¨‹åˆå§‹åŒ–" class="headerlink" title="1. çº¿ç¨‹æ± ä¸åå°çº¿ç¨‹åˆå§‹åŒ–"></a>1. çº¿ç¨‹æ± ä¸åå°çº¿ç¨‹åˆå§‹åŒ–</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@PostConstruct &#x3D; Spring åˆå§‹åŒ–è¿™ä¸ªç±»ä¹‹åç«‹åˆ»æ‰§è¡Œè¯¥æ–¹æ³•ã€‚</p>
<p>è¿™é‡Œåšäº†ä¸€ä»¶äº‹ï¼š</p>
<p>ğŸ‘‰ <strong>å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ä¸åœç›‘å¬ Redis Streamï¼Œå¤„ç†è®¢å•</strong></p>
<p>åˆ›å»ºçº¿ç¨‹æ± ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span></span><br><span class="line">        Executors.newSingleThreadExecutor();</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨å•çº¿ç¨‹æ˜¯ä¸ºäº†é¿å…å¤šä¸ªçº¿ç¨‹å¹¶å‘å¤„ç†ç›¸åŒç”¨æˆ·çš„è®¢å•ã€‚</p>
<hr>
<h3 id="â­-1-1ç§’æ€ç³»ç»Ÿä¸ºä»€ä¹ˆè¦åå°çº¿ç¨‹ï¼Ÿ"><a href="#â­-1-1ç§’æ€ç³»ç»Ÿä¸ºä»€ä¹ˆè¦åå°çº¿ç¨‹ï¼Ÿ" class="headerlink" title="â­ 1. 1ç§’æ€ç³»ç»Ÿä¸ºä»€ä¹ˆè¦åå°çº¿ç¨‹ï¼Ÿ"></a>â­ 1. 1ç§’æ€ç³»ç»Ÿä¸ºä»€ä¹ˆè¦åå°çº¿ç¨‹ï¼Ÿ</h3><p>åœ¨ä½ çš„ä»£ç ä¸­ï¼Œç§’æ€è®¢å•çš„å¤„ç†æ–¹å¼æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·ç‚¹å‡»ç§’æ€æŒ‰é’®  </span><br><span class="line">      â†“  </span><br><span class="line">å†™å…¥ Redis Streamï¼ˆé€Ÿåº¦å¿«ï¼‰  </span><br><span class="line">      â†“  </span><br><span class="line">åå°çº¿ç¨‹æ…¢æ…¢ä» Stream å–æ¶ˆæ¯å¹¶å¤„ç†è®¢å•</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<p>ğŸ‘‰ <strong>ç”¨æˆ·çº¿ç¨‹ä¸ç›´æ¥å»æ“ä½œæ•°æ®åº“</strong><br> ğŸ‘‰ <strong>åå°çº¿ç¨‹è´Ÿè´£çœŸæ­£å†™æ•°æ®åº“ã€æ‰£åº“å­˜</strong></p>
<p>è¿™ä¸ªæœºåˆ¶å« <strong>å¼‚æ­¥ä¸‹å•</strong>ï¼Œèƒ½æœ‰æ•ˆæŠ—ä½é«˜å¹¶å‘ã€‚</p>
<p>è¦å®ç°â€œåå°æ…¢æ…¢å¤„ç†â€ï¼Œéœ€è¦ä¸€ä¸ª <strong>å¸¸é©»çš„åå°çº¿ç¨‹</strong>ã€‚</p>
<hr>
<h3 id="â­-1-2-ä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªæ™®é€šçº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨çº¿ç¨‹æ± ï¼Ÿ"><a href="#â­-1-2-ä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªæ™®é€šçº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨çº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="â­ 1.2. ä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªæ™®é€šçº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨çº¿ç¨‹æ± ï¼Ÿ"></a>â­ 1.2. ä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªæ™®é€šçº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨çº¿ç¨‹æ± ï¼Ÿ</h3><p>ä½ å¯èƒ½ä¼šé—®ï¼š</p>
<blockquote>
<p>ç›´æ¥ new Thread() ä¸è¡Œå—ï¼Ÿ</p>
</blockquote>
<p>å¯ä»¥ï¼Œä½†ä¸æ¨èã€‚åŸå› å¦‚ä¸‹ï¼š</p>
<hr>
<h4 id="âœ”-1-2-1-çº¿ç¨‹æ± æ›´ä¸“ä¸šã€æ›´å®‰å…¨"><a href="#âœ”-1-2-1-çº¿ç¨‹æ± æ›´ä¸“ä¸šã€æ›´å®‰å…¨" class="headerlink" title="âœ” 1.2.1 çº¿ç¨‹æ± æ›´ä¸“ä¸šã€æ›´å®‰å…¨"></a>âœ” 1.2.1 çº¿ç¨‹æ± æ›´ä¸“ä¸šã€æ›´å®‰å…¨</h4><p>å¦‚æœä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>()).start();</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ä¸‹é¢é—®é¢˜ï¼š</p>
<h4 id="âŒ-çº¿ç¨‹æ„å¤–ç»“æŸï¼Œæ— æ³•è‡ªåŠ¨æ¢å¤"><a href="#âŒ-çº¿ç¨‹æ„å¤–ç»“æŸï¼Œæ— æ³•è‡ªåŠ¨æ¢å¤" class="headerlink" title="âŒ çº¿ç¨‹æ„å¤–ç»“æŸï¼Œæ— æ³•è‡ªåŠ¨æ¢å¤"></a>âŒ çº¿ç¨‹æ„å¤–ç»“æŸï¼Œæ— æ³•è‡ªåŠ¨æ¢å¤</h4><p>æ¯”å¦‚æŠ›å¼‚å¸¸å¯¼è‡´çº¿ç¨‹æŒ‚æ‰ â†’ ç³»ç»Ÿæ— äººå¤„ç†è®¢å•ï¼Œä¸¥é‡äº‹æ•…ï¼</p>
<p>çº¿ç¨‹æ± åˆ™ä¼šï¼š</p>
<p>âœ” è‡ªåŠ¨ç®¡ç†çº¿ç¨‹<br> âœ” è‡ªåŠ¨æ•è·é”™è¯¯<br> âœ” çº¿ç¨‹æ„å¤–æ­»äº¡åè‡ªåŠ¨é‡å¯æ–°çš„çº¿ç¨‹ï¼ˆå…·ä½“å–å†³äºæ± ç±»å‹ï¼‰</p>
<hr>
<h4 id="âœ”-1-2-2-newSingleThreadExecutor-æ°¸ä¹…å•çº¿ç¨‹å¤„ç†è®¢å•"><a href="#âœ”-1-2-2-newSingleThreadExecutor-æ°¸ä¹…å•çº¿ç¨‹å¤„ç†è®¢å•" class="headerlink" title="âœ” 1.2.2 newSingleThreadExecutor() &#x3D; æ°¸ä¹…å•çº¿ç¨‹å¤„ç†è®¢å•"></a>âœ” 1.2.2 newSingleThreadExecutor() &#x3D; æ°¸ä¹…å•çº¿ç¨‹å¤„ç†è®¢å•</h4><p>ä½ ç”¨çš„æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Executors.newSingleThreadExecutor();</span><br></pre></td></tr></table></figure>

<p>å®ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>
<h4 id="ç‰¹ç‚¹ä¸€ï¼šæ°¸è¿œåªæœ‰ä¸€ä¸ªçº¿ç¨‹"><a href="#ç‰¹ç‚¹ä¸€ï¼šæ°¸è¿œåªæœ‰ä¸€ä¸ªçº¿ç¨‹" class="headerlink" title="ç‰¹ç‚¹ä¸€ï¼šæ°¸è¿œåªæœ‰ä¸€ä¸ªçº¿ç¨‹"></a>ç‰¹ç‚¹ä¸€ï¼š<strong>æ°¸è¿œåªæœ‰ä¸€ä¸ªçº¿ç¨‹</strong></h4><p>ä¿è¯ï¼š</p>
<p>âœ” åŒä¸€æ—¶é—´åªæœ‰ 1 ä¸ªæ¶ˆè´¹è€…åœ¨æ“ä½œ<br> âœ” ä¸ä¼šå‡ºç°å¹¶å‘å†™æ•°æ®åº“å¯¼è‡´è¶…å–<br> âœ” é¡ºåºæ¶ˆè´¹ Redis Stream</p>
<p>è¿™å¯¹ç§’æ€ç³»ç»Ÿéå¸¸å…³é”®ã€‚</p>
<hr>
<h4 id="ç‰¹ç‚¹äºŒï¼šçº¿ç¨‹æŒ‚äº†ä¼šè‡ªåŠ¨æ‹‰èµ·æ–°çº¿ç¨‹"><a href="#ç‰¹ç‚¹äºŒï¼šçº¿ç¨‹æŒ‚äº†ä¼šè‡ªåŠ¨æ‹‰èµ·æ–°çº¿ç¨‹" class="headerlink" title="ç‰¹ç‚¹äºŒï¼šçº¿ç¨‹æŒ‚äº†ä¼šè‡ªåŠ¨æ‹‰èµ·æ–°çº¿ç¨‹"></a>ç‰¹ç‚¹äºŒï¼šçº¿ç¨‹æŒ‚äº†ä¼šè‡ªåŠ¨æ‹‰èµ·æ–°çº¿ç¨‹</h4><p>æ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br></pre></td></tr></table></figure>

<p>æ™®é€šçº¿ç¨‹ä¼šæ­»æ‰ï¼Œè€Œçº¿ç¨‹æ± ä¼šè‡ªåŠ¨ï¼š</p>
<p>âš ï¸ çº¿ç¨‹å¼‚å¸¸ â†’ âŒçº¿ç¨‹ç»“æŸ â†’ âœ”ï¸ è‡ªåŠ¨æ–°å»ºçº¿ç¨‹æ›¿ä»£ â†’ ç³»ç»Ÿç»§ç»­æ­£å¸¸ä¸‹å•</p>
<p>è¿™å°±æ˜¯çº¿ç¨‹æ± çš„æ„ä¹‰ã€‚</p>
<hr>
<h3 id="â­-1-3-ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çº¿ç¨‹æ± ï¼Ÿ"><a href="#â­-1-3-ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="â­ 1.3. ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çº¿ç¨‹æ± ï¼Ÿ"></a>â­ 1.3. ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çº¿ç¨‹æ± ï¼Ÿ</h3><p>å› ä¸ºä¸‹è®¢å•è¦æ»¡è¶³ä¸¤ä¸ªè¦æ±‚ï¼š</p>
<hr>
<h4 id="âœ”-è¦æ±‚-1ï¼šé¡ºåºå¤„ç†è®¢å•"><a href="#âœ”-è¦æ±‚-1ï¼šé¡ºåºå¤„ç†è®¢å•" class="headerlink" title="âœ” è¦æ±‚ 1ï¼šé¡ºåºå¤„ç†è®¢å•"></a>âœ” è¦æ±‚ 1ï¼šé¡ºåºå¤„ç†è®¢å•</h4><p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>ç”¨æˆ· 1001</li>
<li>åŒä¸€æ—¶é—´ç‚¹ç–¯ç‹‚ç‚¹å‡»ç§’æ€</li>
</ul>
<p>å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†ä¼šï¼š</p>
<p>âœ” æ•°æ®åº“å¹¶å‘è®¿é—®<br> âœ” å¹¶å‘æ‰£åº“å­˜<br> âœ” å¹¶å‘ä¸‹å•ï¼ˆå†²çªï¼‰</p>
<p>ä½¿ç”¨ <strong>å•çº¿ç¨‹</strong>ï¼š</p>
<p>ğŸ‘‰ æ‰€æœ‰è®¢å• <strong>æ’é˜Ÿ</strong> æ‰§è¡Œ<br> ğŸ‘‰ é¡ºåºå¤„ç†<br> ğŸ‘‰ é¿å…å†²çª</p>
<hr>
<h4 id="âœ”-è¦æ±‚-2ï¼šé˜²æ­¢å¹¶å‘æ‰£åº“å­˜ã€å†²çªä¸‹å•"><a href="#âœ”-è¦æ±‚-2ï¼šé˜²æ­¢å¹¶å‘æ‰£åº“å­˜ã€å†²çªä¸‹å•" class="headerlink" title="âœ” è¦æ±‚ 2ï¼šé˜²æ­¢å¹¶å‘æ‰£åº“å­˜ã€å†²çªä¸‹å•"></a>âœ” è¦æ±‚ 2ï¼šé˜²æ­¢å¹¶å‘æ‰£åº“å­˜ã€å†²çªä¸‹å•</h4><p>å¦‚æœç”¨å¤šçº¿ç¨‹ï¼š</p>
<ul>
<li>ä¸¤æ¡æ¶ˆæ¯å¯èƒ½è¢«ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†</li>
<li>å¯¼è‡´ <strong>åº“å­˜å‡æˆè´Ÿæ•°</strong></li>
<li>å¯¼è‡´ç”¨æˆ· â€œä¸€äººå¤šå•â€</li>
</ul>
<p>è€Œå•çº¿ç¨‹ &#x3D; ç»å¯¹å®‰å…¨ã€‚</p>
<hr>
<h3 id="â­-1-4-newSingleThreadExecutor-ä¸-new-Thread-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#â­-1-4-newSingleThreadExecutor-ä¸-new-Thread-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="â­ 1.4. newSingleThreadExecutor() ä¸ new Thread æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>â­ 1.4. newSingleThreadExecutor() ä¸ new Thread æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><table>
<thead>
<tr>
<th>å†™æ³•</th>
<th>ä¼šæ€æ ·</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><code>new Thread()</code></td>
<td>åˆ›å»ºä¸€æ¬¡åå°±ç»“æŸã€‚å¼‚å¸¸ä¼šè®©çº¿ç¨‹æ­»æ‰ï¼Œæ²¡æ³•è‡ªåŠ¨æ¢å¤ã€‚</td>
<td>ç®€å•æµ‹è¯•</td>
</tr>
<tr>
<td><code>newSingleThreadExecutor()</code></td>
<td>æ°¸è¿œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸æ—¶è‡ªåŠ¨åˆ›å»ºæ–°çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚</td>
<td>éœ€è¦<strong>é•¿æœŸç¨³å®šè¿è¡Œ</strong>çš„åå°ä»»åŠ¡</td>
</tr>
</tbody></table>
<p>ç§’æ€è®¢å•å¤„ç†å±äºï¼š</p>
<p>ğŸ‘‰ <strong>å¿…é¡»é•¿æœŸç¨³å®šè¿è¡Œ</strong><br> ğŸ‘‰ <strong>å¿…é¡»é¡ºåºæ‰§è¡Œ</strong><br> ğŸ‘‰ <strong>ä¸èƒ½å´©æºƒ</strong></p>
<p>æ‰€ä»¥å¿…é¡»ç”¨ <strong>å•çº¿ç¨‹çº¿ç¨‹æ± </strong>ã€‚</p>
<hr>
<h3 id="â­-1-5-æ€»ç»“ï¼ˆæœ€é‡è¦ï¼Œé¢è¯•å¿…èƒŒï¼‰"><a href="#â­-1-5-æ€»ç»“ï¼ˆæœ€é‡è¦ï¼Œé¢è¯•å¿…èƒŒï¼‰" class="headerlink" title="â­ 1.5. æ€»ç»“ï¼ˆæœ€é‡è¦ï¼Œé¢è¯•å¿…èƒŒï¼‰"></a>â­ 1.5. æ€»ç»“ï¼ˆæœ€é‡è¦ï¼Œé¢è¯•å¿…èƒŒï¼‰</h3><p>ä½¿ç”¨çº¿ç¨‹æ± çš„åŸå› ï¼š</p>
<h3 id="âœ”-1-éœ€è¦åå°çº¿ç¨‹é•¿æœŸè¿è¡Œï¼ˆéç”¨æˆ·çº¿ç¨‹ï¼‰"><a href="#âœ”-1-éœ€è¦åå°çº¿ç¨‹é•¿æœŸè¿è¡Œï¼ˆéç”¨æˆ·çº¿ç¨‹ï¼‰" class="headerlink" title="âœ” 1. éœ€è¦åå°çº¿ç¨‹é•¿æœŸè¿è¡Œï¼ˆéç”¨æˆ·çº¿ç¨‹ï¼‰"></a>âœ” 1. éœ€è¦åå°çº¿ç¨‹é•¿æœŸè¿è¡Œï¼ˆéç”¨æˆ·çº¿ç¨‹ï¼‰</h3><h3 id="âœ”-2-çº¿ç¨‹æ± èƒ½è‡ªåŠ¨é‡å¯çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹å´©æºƒå¯¼è‡´ç³»ç»Ÿåœæ‘†"><a href="#âœ”-2-çº¿ç¨‹æ± èƒ½è‡ªåŠ¨é‡å¯çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹å´©æºƒå¯¼è‡´ç³»ç»Ÿåœæ‘†" class="headerlink" title="âœ” 2. çº¿ç¨‹æ± èƒ½è‡ªåŠ¨é‡å¯çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹å´©æºƒå¯¼è‡´ç³»ç»Ÿåœæ‘†"></a>âœ” 2. çº¿ç¨‹æ± èƒ½è‡ªåŠ¨é‡å¯çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹å´©æºƒå¯¼è‡´ç³»ç»Ÿåœæ‘†</h3><h3 id="âœ”-3-å•çº¿ç¨‹æ± ä¿è¯è®¢å•å¤„ç†å®Œå…¨é¡ºåºï¼Œé¿å…å¹¶å‘é—®é¢˜"><a href="#âœ”-3-å•çº¿ç¨‹æ± ä¿è¯è®¢å•å¤„ç†å®Œå…¨é¡ºåºï¼Œé¿å…å¹¶å‘é—®é¢˜" class="headerlink" title="âœ” 3. å•çº¿ç¨‹æ± ä¿è¯è®¢å•å¤„ç†å®Œå…¨é¡ºåºï¼Œé¿å…å¹¶å‘é—®é¢˜"></a>âœ” 3. å•çº¿ç¨‹æ± ä¿è¯è®¢å•å¤„ç†å®Œå…¨é¡ºåºï¼Œé¿å…å¹¶å‘é—®é¢˜</h3><h3 id="âœ”-4-é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè®¢å•è¦æ’é˜Ÿæ…¢æ…¢å¤„ç†ï¼Œæ‰€ä»¥å•çº¿ç¨‹æœ€åˆé€‚"><a href="#âœ”-4-é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè®¢å•è¦æ’é˜Ÿæ…¢æ…¢å¤„ç†ï¼Œæ‰€ä»¥å•çº¿ç¨‹æœ€åˆé€‚" class="headerlink" title="âœ” 4. é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè®¢å•è¦æ’é˜Ÿæ…¢æ…¢å¤„ç†ï¼Œæ‰€ä»¥å•çº¿ç¨‹æœ€åˆé€‚"></a>âœ” 4. é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè®¢å•è¦æ’é˜Ÿæ…¢æ…¢å¤„ç†ï¼Œæ‰€ä»¥å•çº¿ç¨‹æœ€åˆé€‚</h3><h3 id="âœ”-5-æ¯”-new-Thread-æ›´å®‰å…¨ã€æ›´ä¸“ä¸šã€æ›´ä¸å®¹æ˜“å‡º-bug"><a href="#âœ”-5-æ¯”-new-Thread-æ›´å®‰å…¨ã€æ›´ä¸“ä¸šã€æ›´ä¸å®¹æ˜“å‡º-bug" class="headerlink" title="âœ” 5. æ¯” new Thread æ›´å®‰å…¨ã€æ›´ä¸“ä¸šã€æ›´ä¸å®¹æ˜“å‡º bug"></a>âœ” 5. æ¯” new Thread æ›´å®‰å…¨ã€æ›´ä¸“ä¸šã€æ›´ä¸å®¹æ˜“å‡º bug</h3><h2 id="2-Redis-Stream-æ¶ˆæ¯é˜Ÿåˆ—"><a href="#2-Redis-Stream-æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="2. Redis Stream æ¶ˆæ¯é˜Ÿåˆ—"></a>2. Redis Stream æ¶ˆæ¯é˜Ÿåˆ—</h2><p>é˜Ÿåˆ—åç§°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream.orders&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>åå°çº¿ç¨‹çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<h3 id="è¯»å–æ¶ˆæ¯"><a href="#è¯»å–æ¶ˆæ¯" class="headerlink" title="è¯»å–æ¶ˆæ¯"></a>è¯»å–æ¶ˆæ¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.opsForStream().read(</span><br><span class="line">    Consumer.from(<span class="string">&quot;g1&quot;</span>,<span class="string">&quot;c1&quot;</span>),</span><br><span class="line">    StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">1</span>)),</span><br><span class="line">    StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP g1 c1 COUNT <span class="number">1</span> BLOCK <span class="number">1000</span> STREAMS stream.orders &gt;</span><br></pre></td></tr></table></figure>

<p>æ„æ€ï¼š</p>
<ul>
<li><p>GROUP g1ï¼šæ¶ˆè´¹è€…ç»„</p>
</li>
<li><p>c1ï¼šæ¶ˆè´¹è€…</p>
</li>
<li><p>BLOCK 1000ï¼šé˜»å¡ 1 ç§’</p>
</li>
<li><blockquote>
<p>ï¼šè¯»å–æœªæ¶ˆè´¹çš„æ–°æ¶ˆæ¯</p>
</blockquote>
</li>
</ul>
<h3 id="è½¬æˆ-Java-å¯¹è±¡"><a href="#è½¬æˆ-Java-å¯¹è±¡" class="headerlink" title="è½¬æˆ Java å¯¹è±¡"></a>è½¬æˆ Java å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(messageMap,<span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(),<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>Stream çš„æ¶ˆæ¯è¯»å‡ºæ¥æ˜¯ Mapï¼Œè¿™é‡Œè½¬æ¢ä¸º VoucherOrder å¯¹è±¡ã€‚</p>
<h3 id="æ‰§è¡Œè®¢å•é€»è¾‘-ACK"><a href="#æ‰§è¡Œè®¢å•é€»è¾‘-ACK" class="headerlink" title="æ‰§è¡Œè®¢å•é€»è¾‘ &amp; ACK"></a>æ‰§è¡Œè®¢å•é€»è¾‘ &amp; ACK</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">handleVoucherOrder(voucherOrder);</span><br><span class="line">stringRedisTemplate.opsForStream().acknowledge(queueName,<span class="string">&quot;g1&quot;</span>,record.getId());</span><br></pre></td></tr></table></figure>

<p>å¤„ç†æˆåŠŸåå¿…é¡» ACKï¼Œå¦åˆ™ Redis ä¼šè®¤ä¸ºæ²¡æœ‰å¤„ç†æˆåŠŸã€‚</p>
<h3 id="2-1-1å…ˆçœ‹è¿™ä¸€æ®µ-Java-ä»£ç åˆ°åº•å¹²äº†å•¥"><a href="#2-1-1å…ˆçœ‹è¿™ä¸€æ®µ-Java-ä»£ç åˆ°åº•å¹²äº†å•¥" class="headerlink" title="2.1.1å…ˆçœ‹è¿™ä¸€æ®µ Java ä»£ç åˆ°åº•å¹²äº†å•¥"></a>2.1.1å…ˆçœ‹è¿™ä¸€æ®µ Java ä»£ç åˆ°åº•å¹²äº†å•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MapRecord&lt;String, Object, Object&gt;&gt; messageList =</span><br><span class="line">        stringRedisTemplate.opsForStream().read(</span><br><span class="line">            Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">            StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">1</span>)),</span><br><span class="line">            StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ†æˆ 3 å—æ¥çœ‹ï¼š</p>
<ol>
<li><code>Consumer.from(&quot;g1&quot;, &quot;c1&quot;)</code></li>
<li><code>StreamReadOptions...</code></li>
<li><code>StreamOffset.create(...)</code></li>
</ol>
<hr>
<h3 id="1ï¸âƒ£-Consumer-from-â€œg1â€-â€œc1â€"><a href="#1ï¸âƒ£-Consumer-from-â€œg1â€-â€œc1â€" class="headerlink" title="1ï¸âƒ£ Consumer.from(â€œg1â€, â€œc1â€)"></a>1ï¸âƒ£ Consumer.from(â€œg1â€, â€œc1â€)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Consumer.from(&quot;g1&quot;, &quot;c1&quot;)</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äºå‘½ä»¤é‡Œçš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP g1 c1 ...</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šï¼š</p>
<ul>
<li><code>&quot;g1&quot;</code>ï¼šæ¶ˆè´¹è€…ç»„åï¼ˆgroupï¼‰</li>
<li><code>&quot;c1&quot;</code>ï¼šæ¶ˆè´¹è€…åï¼ˆconsumerï¼‰</li>
</ul>
<p>åœ¨ Redis Stream çš„æ¶ˆè´¹è€…ç»„æ¨¡å‹ä¸­ï¼š</p>
<ul>
<li>ä¸€ä¸ª <strong>Stream</strong> å¯ä»¥æœ‰å¤šä¸ª <strong>æ¶ˆè´¹è€…ç»„(group)</strong></li>
<li>ä¸€ä¸ª <strong>ç»„</strong> ä¸­å¯ä»¥æœ‰å¤šä¸ª <strong>æ¶ˆè´¹è€…(consumer)</strong></li>
<li>ç»„æ§åˆ¶â€œè¿™æ¡æ¶ˆæ¯è¢«å“ªä¸ªç»„æ¶ˆè´¹äº†â€ï¼Œ</li>
<li>ç»„é‡Œé¢çš„æ¶ˆè´¹è€…æ§åˆ¶â€œåŒä¸€æ¡æ¶ˆæ¯åœ¨ç»„å†…åˆ†é…ç»™å“ªä¸ªå…·ä½“æ¶ˆè´¹è€…â€ã€‚</li>
</ul>
<p>ä½ è¿™é‡Œï¼š</p>
<ul>
<li>åªç”¨ä¸€ä¸ªç»„ï¼š<code>g1</code></li>
<li>åªç”¨ä¸€ä¸ªæ¶ˆè´¹è€…ï¼š<code>c1</code></li>
<li>æ‰€ä»¥å°±æ˜¯å•çº¿ç¨‹é¡ºåºæ¶ˆè´¹ï¼ˆé…åˆå•çº¿ç¨‹çº¿ç¨‹æ± ï¼‰</li>
</ul>
<hr>
<h3 id="2ï¸âƒ£-StreamReadOptions-empty-count-1-block-Duration-ofSeconds-1"><a href="#2ï¸âƒ£-StreamReadOptions-empty-count-1-block-Duration-ofSeconds-1" class="headerlink" title="2ï¸âƒ£ StreamReadOptions.empty().count(1).block(Duration.ofSeconds(1))"></a>2ï¸âƒ£ StreamReadOptions.empty().count(1).block(Duration.ofSeconds(1))</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StreamReadOptions.empty()</span><br><span class="line">        .count(<span class="number">1</span>)</span><br><span class="line">        .block(Duration.ofSeconds(<span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯æ„é€  <code>XREADGROUP</code> çš„ä¸€äº›å‚æ•°ï¼š</p>
<h4 id="count-1"><a href="#count-1" class="headerlink" title="count(1)"></a><code>count(1)</code></h4><ul>
<li>å¯¹åº”å‘½ä»¤ä¸­çš„ <code>COUNT 1</code></li>
<li>ä»£è¡¨ï¼š<strong>ä¸€æ¬¡æœ€å¤šæ‹¿ 1 æ¡æ¶ˆæ¯</strong></li>
</ul>
<p>ğŸ‘‰ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªçº¿ç¨‹æ˜¯<strong>ä¸€æ¡ä¸€æ¡</strong>ä» Redis ä¸­å–è®¢å•æ¥å¤„ç†ã€‚</p>
<h4 id="block-Duration-ofSeconds-1"><a href="#block-Duration-ofSeconds-1" class="headerlink" title="block(Duration.ofSeconds(1))"></a><code>block(Duration.ofSeconds(1))</code></h4><ul>
<li>å¯¹åº”å‘½ä»¤ä¸­çš„ <code>BLOCK 1000</code></li>
<li>è¡¨ç¤ºï¼šå¦‚æœé˜Ÿåˆ—æš‚æ—¶æ²¡æ¶ˆæ¯ï¼Œå°±<strong>æœ€å¤šé˜»å¡ 1 ç§’é’Ÿ</strong>ç­‰æ¶ˆæ¯</li>
<li>1 ç§’å†…å¦‚æœæœ‰æ–°æ¶ˆæ¯æ¥ï¼Œå°±ç«‹åˆ»è¿”å›</li>
<li>è¶…è¿‡ 1 ç§’è¿˜æ²¡æœ‰æ¶ˆæ¯ â†’ è¿”å› <code>null</code> æˆ–ç©ºåˆ—è¡¨ â†’ ä»£ç ä¼š <code>continue</code> å†å¾ªç¯ä¸€æ¬¡</li>
</ul>
<p>å¥½å¤„ï¼š</p>
<ul>
<li>é¿å… while(true) æ­»å¾ªç¯ + ç©ºè½¬ CPU</li>
<li>åŒæ—¶åˆèƒ½åšåˆ°â€œæœ‰æ¶ˆæ¯ç«‹åˆ»å¤„ç†â€</li>
</ul>
<hr>
<h3 id="3ï¸âƒ£-StreamOffset-create-queueName-ReadOffset-lastConsumed"><a href="#3ï¸âƒ£-StreamOffset-create-queueName-ReadOffset-lastConsumed" class="headerlink" title="3ï¸âƒ£ StreamOffset.create(queueName, ReadOffset.lastConsumed())"></a>3ï¸âƒ£ StreamOffset.create(queueName, ReadOffset.lastConsumed())</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äºå‘½ä»¤é‡Œçš„ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STREAMS stream.orders &gt;</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹æ˜¯è¿™ä¸ªï¼š<code>ReadOffset.lastConsumed()</code> å¯¹åº”çš„æ˜¯ <code>&gt;</code>ã€‚</p>
<p>åœ¨ <code>XREADGROUP</code> ä¸­ï¼Œ<code>&gt;</code> çš„å«ä¹‰æ˜¯ï¼š</p>
<blockquote>
<p><strong>åªè¯»å–è¿™ä¸ªæ¶ˆè´¹è€…ç»„è¿˜æ²¡æœ‰åˆ†é…è¿‡çš„â€œæ–°æ¶ˆæ¯â€</strong></p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯ï¼š</p>
<ul>
<li>ä¸ä¼šå†å»è¯»å·²ç»ç»™æœ¬ç»„æ¶ˆè´¹è€…åˆ†é…è¿‡çš„æ—§æ¶ˆæ¯</li>
<li>åªæ‹¿â€œæµä¸­æœ€è¿‘æ–°åˆ°çš„æ¶ˆæ¯â€ï¼Œç»„é‡Œæ²¡äººå¤„ç†è¿‡çš„</li>
</ul>
<p>ç®€åŒ–ç†è§£ï¼š</p>
<ul>
<li><code>&gt;</code> &#x3D; â€œæˆ‘è¦æ–°æ¶ˆæ¯â€</li>
<li><code>0</code> &#x3D; â€œæˆ‘è¦ PendingList é‡Œæ²¡ ACK çš„æ—§æ¶ˆæ¯â€ï¼ˆä½ åœ¨ <code>handlePendingList()</code> å°±ç”¨äº†è¿™ä¸ªï¼‰</li>
</ul>
<hr>
<h3 id="2-1-2æŠŠ-Java-è°ƒç”¨ç¿»è¯‘æˆ-Redis-å‘½ä»¤"><a href="#2-1-2æŠŠ-Java-è°ƒç”¨ç¿»è¯‘æˆ-Redis-å‘½ä»¤" class="headerlink" title="2.1.2æŠŠ Java è°ƒç”¨ç¿»è¯‘æˆ Redis å‘½ä»¤"></a>2.1.2æŠŠ Java è°ƒç”¨ç¿»è¯‘æˆ Redis å‘½ä»¤</h3><p>ä½ çš„è¿™ä¸€æ®µ Javaï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.opsForStream().read(</span><br><span class="line">    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">    StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">1</span>)),</span><br><span class="line">    StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>å¤§è‡´ç­‰ä»·äºï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP g1 c1 COUNT <span class="number">1</span> BLOCK <span class="number">1000</span> STREAMS stream.orders &gt;</span><br></pre></td></tr></table></figure>

<p>å«ä¹‰ï¼š</p>
<ul>
<li><code>GROUP g1 c1</code>ï¼šä»¥æ¶ˆè´¹è€…ç»„ <code>g1</code>ã€æ¶ˆè´¹è€… <code>c1</code> çš„èº«ä»½è¯»å–</li>
<li><code>COUNT 1</code>ï¼šæœ€å¤š 1 æ¡</li>
<li><code>BLOCK 1000</code>ï¼šæœ€å¤šé˜»å¡ 1000msï¼ˆ1ç§’ï¼‰</li>
<li><code>STREAMS stream.orders</code>ï¼šä» <code>stream.orders</code> è¿™ä¸ª Stream è¯»</li>
<li><code>&gt;</code>ï¼šè¯»è¿™ä¸ªç»„ä¸­â€œè¿˜æ²¡åˆ†é…è¿‡çš„æ–°æ¶ˆæ¯â€</li>
</ul>
<hr>
<h3 id="2-1-3è¯»å‡ºæ¥åè½¬æˆ-Java-å¯¹è±¡"><a href="#2-1-3è¯»å‡ºæ¥åè½¬æˆ-Java-å¯¹è±¡" class="headerlink" title="2.1.3è¯»å‡ºæ¥åè½¬æˆ Java å¯¹è±¡"></a>2.1.3è¯»å‡ºæ¥åè½¬æˆ Java å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MapRecord&lt;String, Object, Object&gt; record = messageList.get(<span class="number">0</span>);</span><br><span class="line">Map&lt;Object, Object&gt; messageMap = record.getValue();</span><br><span class="line"><span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(messageMap, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>åˆ†è§£è§£é‡Šï¼š</p>
<h3 id="1ï¸âƒ£-MapRecord-æ˜¯-Redis-Stream-çš„æ¶ˆæ¯å°è£…"><a href="#1ï¸âƒ£-MapRecord-æ˜¯-Redis-Stream-çš„æ¶ˆæ¯å°è£…" class="headerlink" title="1ï¸âƒ£ MapRecord æ˜¯ Redis Stream çš„æ¶ˆæ¯å°è£…"></a>1ï¸âƒ£ <code>MapRecord</code> æ˜¯ Redis Stream çš„æ¶ˆæ¯å°è£…</h3><ul>
<li>ä¸€ä¸ª Stream çš„ entry å°±æ˜¯ä¸€æ¡æ¶ˆæ¯</li>
<li>é‡Œé¢æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª Mapï¼Œä¾‹å¦‚ï¼š</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XADD stream.orders * userId <span class="number">123</span> voucherId <span class="number">5</span> orderId <span class="number">777</span></span><br></pre></td></tr></table></figure>

<p>è¯»å–å‡ºæ¥å°±æ˜¯ä¸€ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Object, Object&gt; = &#123;</span><br><span class="line">    <span class="string">&quot;userId&quot;</span> -&gt; <span class="number">123</span>,</span><br><span class="line">    <span class="string">&quot;voucherId&quot;</span> -&gt; <span class="number">5</span>,</span><br><span class="line">    <span class="string">&quot;orderId&quot;</span> -&gt; <span class="number">777</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2ï¸âƒ£-BeanUtil-fillBeanWithMap-â€¦"><a href="#2ï¸âƒ£-BeanUtil-fillBeanWithMap-â€¦" class="headerlink" title="2ï¸âƒ£ BeanUtil.fillBeanWithMap(â€¦)"></a>2ï¸âƒ£ BeanUtil.fillBeanWithMap(â€¦)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span></span><br><span class="line">    BeanUtil.fillBeanWithMap(messageMap, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>ç›¸å½“äºå¹²äº†è¿™ä»¶äº‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">voucherOrder.setUserId(<span class="number">123L</span>);</span><br><span class="line">voucherOrder.setVoucherId(<span class="number">5L</span>);</span><br><span class="line">voucherOrder.setId(<span class="number">777L</span>);</span><br><span class="line"><span class="comment">// ... æŒ‰å­—æ®µåä¸€ä¸ªä¸ªæ³¨å…¥</span></span><br></pre></td></tr></table></figure>

<p><code>true</code> è¡¨ç¤ºï¼š</p>
<ul>
<li>æ”¯æŒå¿½ç•¥å¤§å°å†™</li>
<li>å°è¯•è¿›è¡Œä¸€äº›ç±»å‹è½¬æ¢ï¼ˆå­—ç¬¦ä¸² â†’ Longï¼‰</li>
</ul>
<hr>
<h3 id="2-1-4æ‰§è¡Œè®¢å•é€»è¾‘-ACK"><a href="#2-1-4æ‰§è¡Œè®¢å•é€»è¾‘-ACK" class="headerlink" title="2.1.4æ‰§è¡Œè®¢å•é€»è¾‘ + ACK"></a>2.1.4æ‰§è¡Œè®¢å•é€»è¾‘ + ACK</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">handleVoucherOrder(voucherOrder);</span><br><span class="line">stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br></pre></td></tr></table></figure>

<h3 id="1ï¸âƒ£-handleVoucherOrder-voucherOrder"><a href="#1ï¸âƒ£-handleVoucherOrder-voucherOrder" class="headerlink" title="1ï¸âƒ£ handleVoucherOrder(voucherOrder);"></a>1ï¸âƒ£ <code>handleVoucherOrder(voucherOrder);</code></h3><p>å†…éƒ¨åšçš„ä¸»è¦æ˜¯ï¼š</p>
<ul>
<li>åŠ  Redisson é”ï¼šä¿è¯ä¸€ä¸ªç”¨æˆ·ä¸€äººä¸€å•</li>
<li>è°ƒç”¨ <code>proxy.createVoucherOrder()</code> å†™åº“ + æ‰£åº“å­˜</li>
</ul>
<h3 id="2ï¸âƒ£-acknowledge-queueName-g1-record-getId"><a href="#2ï¸âƒ£-acknowledge-queueName-g1-record-getId" class="headerlink" title="2ï¸âƒ£ acknowledge(queueName, &quot;g1&quot;, record.getId())"></a>2ï¸âƒ£ <code>acknowledge(queueName, &quot;g1&quot;, record.getId())</code></h3><p>ç­‰ä»·äº Redis å‘½ä»¤ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XACK stream.orders g1 &lt;messageId&gt;</span><br></pre></td></tr></table></figure>

<p>ACK çš„ä½œç”¨ï¼š</p>
<ul>
<li>å‘Šè¯‰ Redisï¼š<strong>è¿™æ¡æ¶ˆæ¯æˆ‘å·²ç»å¤„ç†å®Œäº†ï¼Œå¯ä»¥ä» PendingList ä¸­ç§»é™¤äº†</strong></li>
<li>å¦‚æœä¸ ACKï¼š<ul>
<li>æ¶ˆæ¯ä¼šä¸€ç›´ç•™åœ¨ PendingList é‡Œ</li>
<li>Redis è®¤ä¸ºä½ â€œæ‹¿èµ°äº†ï¼Œä½†è¿˜æ²¡å¤„ç†å®Œâ€</li>
</ul>
</li>
</ul>
<p>è¿™å°±å’Œä½  <code>handlePendingList()</code> æ–¹æ³•å…³è”èµ·æ¥äº†ğŸ‘‡</p>
<hr>
<h3 id="2-1-5Redis-Stream-â€œæ¶ˆè´¹è€…ç»„â€-çš„ç‰¹æ€§ï¼ˆé‡ç‚¹ï¼‰"><a href="#2-1-5Redis-Stream-â€œæ¶ˆè´¹è€…ç»„â€-çš„ç‰¹æ€§ï¼ˆé‡ç‚¹ï¼‰" class="headerlink" title="2.1.5Redis Stream â€œæ¶ˆè´¹è€…ç»„â€ çš„ç‰¹æ€§ï¼ˆé‡ç‚¹ï¼‰"></a>2.1.5Redis Stream â€œæ¶ˆè´¹è€…ç»„â€ çš„ç‰¹æ€§ï¼ˆé‡ç‚¹ï¼‰</h3><p>ä½ å·²ç»åœ¨ç”¨æ¶ˆè´¹è€…ç»„ï¼ˆGROUPï¼‰ï¼Œéå¸¸é‡è¦ã€‚ä¸‹é¢æ˜¯å®ƒçš„å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p>
<hr>
<h3 id="1ï¸âƒ£-ä¸€ä¸ª-Streamï¼Œå¤šç»„æ¶ˆè´¹"><a href="#1ï¸âƒ£-ä¸€ä¸ª-Streamï¼Œå¤šç»„æ¶ˆè´¹" class="headerlink" title="1ï¸âƒ£ ä¸€ä¸ª Streamï¼Œå¤šç»„æ¶ˆè´¹"></a>1ï¸âƒ£ ä¸€ä¸ª Streamï¼Œå¤šç»„æ¶ˆè´¹</h3><ul>
<li>åŒä¸€ä¸ª Streamï¼ˆæ¯”å¦‚ <code>stream.orders</code>ï¼‰å¯ä»¥åˆ›å»ºå¤šä¸ª groupï¼š<ul>
<li>æ¯”å¦‚ <code>g1</code> ä¸“é—¨å¤„ç†ç§’æ€è®¢å•</li>
<li><code>g2</code> ä¸“é—¨åšæ—¥å¿—ç»Ÿè®¡ã€åŸ‹ç‚¹ä¹‹ç±»</li>
</ul>
</li>
</ul>
<p>ä¸åŒç»„ä¹‹é—´æ˜¯ <strong>äº’ä¸å½±å“</strong> çš„ï¼š</p>
<ul>
<li>æ¶ˆæ¯å†™å…¥ä¸€æ¬¡</li>
<li>æ¯ä¸ªç»„éƒ½å¯ä»¥å„è‡ªæ¶ˆè´¹ä¸€é</li>
<li>æœ‰ç‚¹åƒâ€œå¹¿æ’­åˆ°å¤šä¸ªç»„ï¼Œæ¯ç»„è‡ªå·±ç»´æŠ¤è‡ªå·±çš„æ¶ˆè´¹è¿›åº¦â€</li>
</ul>
<hr>
<h3 id="2ï¸âƒ£-ç»„å†…å¤šæ¶ˆè´¹è€…ï¼Œè´Ÿè½½å‡è¡¡"><a href="#2ï¸âƒ£-ç»„å†…å¤šæ¶ˆè´¹è€…ï¼Œè´Ÿè½½å‡è¡¡" class="headerlink" title="2ï¸âƒ£ ç»„å†…å¤šæ¶ˆè´¹è€…ï¼Œè´Ÿè½½å‡è¡¡"></a>2ï¸âƒ£ ç»„å†…å¤šæ¶ˆè´¹è€…ï¼Œè´Ÿè½½å‡è¡¡</h3><p>ä¸€ä¸ª group é‡Œå¯ä»¥æœ‰å¤šä¸ª consumerï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>group: <code>g1</code></li>
<li>consumer: <code>c1</code>, <code>c2</code>, <code>c3</code></li>
</ul>
<p>ç‰¹æ€§ï¼š</p>
<ul>
<li>æ¶ˆæ¯ä¼šåœ¨ç»„å†…æ¶ˆè´¹è€…ä¹‹é—´åˆ†é…</li>
<li>ä¸€æ¡æ¶ˆæ¯é€šå¸¸åªä¼šè¢«ç»„å†…ä¸€ä¸ª consumer å¤„ç†</li>
<li>ç›¸å½“äºåšäº†â€œç»„å†…è´Ÿè½½å‡è¡¡â€</li>
</ul>
<p>ä½ ç°åœ¨åªç”¨ä¸€ä¸ªæ¶ˆè´¹è€… <code>c1</code>ï¼Œæ‰€ä»¥ï¼š<br> ğŸ‘‰ æ‰€æœ‰æ¶ˆæ¯éƒ½ç”± <code>c1</code> å¤„ç†ï¼Œé¡ºåºæ€§æœ€å¥½ã€‚</p>
<hr>
<h3 id="3ï¸âƒ£-Pending-Listï¼ˆæœªç¡®è®¤æ¶ˆæ¯åˆ—è¡¨ï¼‰"><a href="#3ï¸âƒ£-Pending-Listï¼ˆæœªç¡®è®¤æ¶ˆæ¯åˆ—è¡¨ï¼‰" class="headerlink" title="3ï¸âƒ£ Pending Listï¼ˆæœªç¡®è®¤æ¶ˆæ¯åˆ—è¡¨ï¼‰"></a>3ï¸âƒ£ Pending Listï¼ˆæœªç¡®è®¤æ¶ˆæ¯åˆ—è¡¨ï¼‰</h3><p>å¯¹æ¯ä¸€ä¸ª <strong>ç»„</strong> + <strong>æ¶ˆè´¹è€…</strong>ï¼ŒRedis ä¼šç»´æŒä¸€ä¸ª PendingListï¼š</p>
<ul>
<li><p>é‡Œé¢æ”¾çš„æ˜¯ï¼š<strong>å·²ç»åˆ†é…ç»™æ¶ˆè´¹è€…ï¼Œä½†è¿˜æ²¡ ACK çš„æ¶ˆæ¯</strong></p>
</li>
<li><p>ä¹Ÿå°±æ˜¯ï¼š</p>
<blockquote>
<p>å·²ç»é€šè¿‡ <code>XREADGROUP</code> å–èµ°ï¼Œä½†æ˜¯æ²¡é€šè¿‡ <code>XACK</code> ç¡®è®¤å¤„ç†å®Œæˆ</p>
</blockquote>
</li>
</ul>
<p>ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…å¤„ç†è¿‡ç¨‹ä¸­æŒ‚äº†ï¼Œæ²¡æ¥å¾—åŠ ACK</li>
<li>æ¶ˆæ¯å°±æ°¸è¿œå¾…åœ¨ PendingList é‡Œ</li>
</ul>
<p>æ‰€ä»¥ä½ æ‰éœ€è¦ <code>handlePendingList()</code> æ¥<strong>è¡¥å¿å¤„ç†æœª ACK çš„æ¶ˆæ¯</strong>ã€‚</p>
<hr>
<h3 id="4ï¸âƒ£-ä¸ºä»€ä¹ˆä½ è¯»-PendingList-ç”¨çš„æ˜¯-offset-â€œ0â€"><a href="#4ï¸âƒ£-ä¸ºä»€ä¹ˆä½ è¯»-PendingList-ç”¨çš„æ˜¯-offset-â€œ0â€" class="headerlink" title="4ï¸âƒ£ ä¸ºä»€ä¹ˆä½ è¯» PendingList ç”¨çš„æ˜¯ offset &#x3D; â€œ0â€"></a>4ï¸âƒ£ ä¸ºä»€ä¹ˆä½ è¯» PendingList ç”¨çš„æ˜¯ offset &#x3D; â€œ0â€</h3><p>å¯¹æ¯”ä¸€ä¸‹ä»£ç ï¼š</p>
<h4 id="è¯»æ–°æ¶ˆæ¯ç”¨ï¼š"><a href="#è¯»æ–°æ¶ˆæ¯ç”¨ï¼š" class="headerlink" title="è¯»æ–°æ¶ˆæ¯ç”¨ï¼š"></a>è¯»æ–°æ¶ˆæ¯ç”¨ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StreamOffset.create(queueName, ReadOffset.lastConsumed()) <span class="comment">// å¯¹åº” &gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="è¯»-PendingList-ç”¨ï¼š"><a href="#è¯»-PendingList-ç”¨ï¼š" class="headerlink" title="è¯» PendingList ç”¨ï¼š"></a>è¯» PendingList ç”¨ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StreamOffset.create(queueName, ReadOffset.from(<span class="string">&quot;0&quot;</span>)) <span class="comment">// å¯¹åº” 0</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ XREADGROUP ä¸­ï¼š</p>
<ul>
<li><code>&gt;</code> ï¼šä»â€œä»æœªåˆ†é…è¿‡çš„æ–°æ¶ˆæ¯â€ä¸­è¯»å–</li>
<li><code>0</code> ï¼šä»è¿™ä¸ªç»„çš„ PendingList ä¸­è¯»å–â€œè¿˜æ²¡ ACK çš„æ—§æ¶ˆæ¯â€</li>
</ul>
<p>æ‰€ä»¥ï¼š</p>
<ul>
<li>æ­£å¸¸é€»è¾‘ï¼š<code>&gt;</code> â†’ æ–°æ¶ˆæ¯</li>
<li>å¼‚å¸¸è¡¥å¿ï¼š<code>0</code> â†’ PendingList ä¸­æœªç¡®è®¤çš„æ¶ˆæ¯</li>
</ul>
<p>è¿™å°±æ˜¯ä½ ä¸¤ä¸ªä¸åŒ read è°ƒç”¨çš„æ ¸å¿ƒåŒºåˆ«ã€‚</p>
<hr>
<h3 id="5ï¸âƒ£-æ¶ˆè´¹è€…ç»„çš„å‡ ä¸ªå…³é”®å¥½å¤„"><a href="#5ï¸âƒ£-æ¶ˆè´¹è€…ç»„çš„å‡ ä¸ªå…³é”®å¥½å¤„" class="headerlink" title="5ï¸âƒ£ æ¶ˆè´¹è€…ç»„çš„å‡ ä¸ªå…³é”®å¥½å¤„"></a>5ï¸âƒ£ æ¶ˆè´¹è€…ç»„çš„å‡ ä¸ªå…³é”®å¥½å¤„</h3><ol>
<li><strong>æ¶ˆæ¯ä¸ä¸¢ï¼š</strong><ul>
<li>å³ä½¿æ¶ˆè´¹è€…æŒ‚äº†ï¼Œæ¶ˆæ¯è¿˜åœ¨ PendingList</li>
<li>ä½ å¯ä»¥é€šè¿‡è¡¥å¿é€»è¾‘é‡æ–°å¤„ç†</li>
</ul>
</li>
<li><strong>æ”¯æŒå¹¿æ’­&#x2F;å¤šç»„æ¶ˆè´¹ï¼š</strong><ul>
<li>ä¸åŒ group å¯ä»¥å„è‡ªç»´æŠ¤ offset</li>
</ul>
</li>
<li><strong>æ”¯æŒæ°´å¹³æ‰©å±•ï¼š</strong><ul>
<li>ä¸€ä¸ª group ä¸‹å¯ä»¥å¢åŠ å¤šä¸ª consumer åšå¹¶å‘æ¶ˆè´¹</li>
<li>ä½ ç°åœ¨ä¸ºäº†é¡ºåºæ€§åªç”¨äº†ä¸€ä¸ª</li>
</ul>
</li>
<li><strong>å¯æŸ¥è¯¢æ¶ˆè´¹çŠ¶æ€ï¼š</strong><ul>
<li>å¯ä»¥ç”¨ <code>XPENDING</code> çœ‹ PendingList ä¸­æœ‰å“ªäº›æ¶ˆæ¯æ²¡å¤„ç†å®Œ</li>
</ul>
</li>
</ol>
<hr>
<h3 id="2-1-6æŠŠæ•´ä½“æµç¨‹å†ä¸²ä¸€ä¸‹ï¼ˆç»“åˆä½ çš„ä»£ç ï¼‰"><a href="#2-1-6æŠŠæ•´ä½“æµç¨‹å†ä¸²ä¸€ä¸‹ï¼ˆç»“åˆä½ çš„ä»£ç ï¼‰" class="headerlink" title="2.1.6æŠŠæ•´ä½“æµç¨‹å†ä¸²ä¸€ä¸‹ï¼ˆç»“åˆä½ çš„ä»£ç ï¼‰"></a>2.1.6æŠŠæ•´ä½“æµç¨‹å†ä¸²ä¸€ä¸‹ï¼ˆç»“åˆä½ çš„ä»£ç ï¼‰</h3><ol>
<li>Lua è„šæœ¬åˆ¤æ–­åº“å­˜ã€ä¸‹å•èµ„æ ¼ï¼Œå†™å…¥ Redis Stream â†’ <code>stream.orders</code></li>
<li>åå°çº¿ç¨‹é€šè¿‡æ¶ˆè´¹è€…ç»„ <code>g1</code>ã€æ¶ˆè´¹è€… <code>c1</code> ä½¿ç”¨ <code>XREADGROUP</code> è¯»å–æ–°æ¶ˆæ¯ï¼ˆ<code>&gt;</code>ï¼‰</li>
<li>è¯»åˆ°æ¶ˆæ¯åï¼š<ul>
<li>è½¬ä¸º <code>VoucherOrder</code></li>
<li>åŠ é” + è°ƒç”¨ <code>createVoucherOrder</code> æ‰£åº“å­˜ + å†™åº“</li>
<li>æˆåŠŸå <code>XACK</code> ç¡®è®¤</li>
</ul>
</li>
<li>å¦‚æœåœ¨ç¬¬ 3 æ­¥ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œæ²¡èµ°åˆ° ACKï¼š<ul>
<li>æ¶ˆæ¯ä¼šç•™åœ¨ PendingList ä¸­</li>
<li>å¼‚å¸¸ catch æ—¶è°ƒç”¨ <code>handlePendingList()</code></li>
<li>é€šè¿‡ <code>XREADGROUP ... 0</code>ï¼ˆReadOffset.from(â€œ0â€)ï¼‰ä» PendingList é‡æ–°å–æ¶ˆæ¯å¤„ç†</li>
<li>å¤„ç†æˆåŠŸå† ACK</li>
</ul>
</li>
</ol>
<h2 id="2-3-Pending-List-å¼‚å¸¸è¡¥å¿"><a href="#2-3-Pending-List-å¼‚å¸¸è¡¥å¿" class="headerlink" title="2.3. Pending List å¼‚å¸¸è¡¥å¿"></a>2.3. Pending List å¼‚å¸¸è¡¥å¿</h2><p>å¦‚æœå¤„ç†è¿‡ç¨‹ä¸­æŠ›å¼‚å¸¸ï¼Œå½“å‰æ¶ˆæ¯ä¸ä¼š ACKï¼Œä¼šè¿›å…¥ PendingListã€‚</p>
<p>ä»£ç ä¼šä¸“é—¨å¤„ç† PendingListï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handlePendingList();</span><br></pre></td></tr></table></figure>

<p>PendingList çš„ç‰¹æ€§ï¼š</p>
<ul>
<li>å­˜æ”¾æœªç¡®è®¤ï¼ˆACKï¼‰çš„æ¶ˆæ¯</li>
<li>é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±</li>
</ul>
<p>å®ç°é€»è¾‘ï¼š</p>
<ul>
<li>è¯»å– PendingListï¼ˆä» ID&#x3D;0 å¼€å§‹ï¼‰</li>
<li>å¦‚æœæ²¡æ¶ˆæ¯å°±é€€å‡º</li>
<li>æœ‰æ¶ˆæ¯ â†’ è½¬å¯¹è±¡ â†’ å¤„ç† â†’ ACK</li>
</ul>
<hr>
<h2 id="2-4-åˆ›å»ºè®¢å•å‰çš„åˆ†å¸ƒå¼é”"><a href="#2-4-åˆ›å»ºè®¢å•å‰çš„åˆ†å¸ƒå¼é”" class="headerlink" title="2.4. åˆ›å»ºè®¢å•å‰çš„åˆ†å¸ƒå¼é”"></a>2.4. åˆ›å»ºè®¢å•å‰çš„åˆ†å¸ƒå¼é”</h2><p>åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(RedisConstants.LOCK_ORDER_KEY + userId);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line"><span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;ä¸€äººåªèƒ½ä¸‹ä¸€å•&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿è¯åŒä¸€ä¸ªç”¨æˆ·ä¸ä¼šå¹¶å‘ç”Ÿæˆå¤šä¸ªè®¢å•ã€‚</p>
<hr>
<h2 id="2-5-Lua-è„šæœ¬åˆ¤æ–­ä¸‹å•èµ„æ ¼ï¼ˆæ ¸å¿ƒï¼‰"><a href="#2-5-Lua-è„šæœ¬åˆ¤æ–­ä¸‹å•èµ„æ ¼ï¼ˆæ ¸å¿ƒï¼‰" class="headerlink" title="2.5. Lua è„šæœ¬åˆ¤æ–­ä¸‹å•èµ„æ ¼ï¼ˆæ ¸å¿ƒï¼‰"></a>2.5. Lua è„šæœ¬åˆ¤æ–­ä¸‹å•èµ„æ ¼ï¼ˆæ ¸å¿ƒï¼‰</h2><p>Lua è„šæœ¬è·¯å¾„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/stream-seckill.lua&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">result = stringRedisTemplate.execute(</span><br><span class="line">    SECKILL_SCRIPT,</span><br><span class="line">    Collections.emptyList(),</span><br><span class="line">    voucherId.toString(),</span><br><span class="line">    userId.toString(),</span><br><span class="line">    String.valueOf(orderId)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>è„šæœ¬è¿”å›å€¼å«ä¹‰ï¼š</p>
<table>
<thead>
<tr>
<th>è¿”å›å€¼</th>
<th>æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>æˆåŠŸï¼Œå…è®¸ä¸‹å•</td>
</tr>
<tr>
<td>1</td>
<td>åº“å­˜ä¸è¶³</td>
</tr>
<tr>
<td>2</td>
<td>é‡å¤ä¸‹å•</td>
</tr>
</tbody></table>
<p>Lua è„šæœ¬ä¸€èˆ¬ä¼šåšï¼š</p>
<ol>
<li>åˆ¤æ–­åº“å­˜æ˜¯å¦ &gt; 0</li>
<li>åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»æŠ¢è¿‡</li>
<li>ç»™åº“å­˜ -1</li>
<li>æŠŠè®¢å•ä¿¡æ¯å†™å…¥ Redis Streamï¼ˆä¸Šé¢æ¶ˆè´¹é‚£é‡Œå–çš„å°±æ˜¯è¿™ä¸ªï¼‰</li>
</ol>
<hr>
<h2 id="2-6-åˆ›å»ºè®¢å•ï¼ˆçœŸæ­£å†™æ•°æ®åº“ï¼‰"><a href="#2-6-åˆ›å»ºè®¢å•ï¼ˆçœŸæ­£å†™æ•°æ®åº“ï¼‰" class="headerlink" title="2.6. åˆ›å»ºè®¢å•ï¼ˆçœŸæ­£å†™æ•°æ®åº“ï¼‰"></a>2.6. åˆ›å»ºè®¢å•ï¼ˆçœŸæ­£å†™æ•°æ®åº“ï¼‰</h2><p>è¿™æ˜¯åå°çº¿ç¨‹è°ƒç”¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy.createVoucherOrder(voucherOrder);</span><br></pre></td></tr></table></figure>

<p>é‡Œé¢åšï¼š</p>
<hr>
<h3 id="ï¼ˆ1ï¼‰æ£€æŸ¥æ˜¯å¦ä¸€äººä¸€å•"><a href="#ï¼ˆ1ï¼‰æ£€æŸ¥æ˜¯å¦ä¸€äººä¸€å•" class="headerlink" title="ï¼ˆ1ï¼‰æ£€æŸ¥æ˜¯å¦ä¸€äººä¸€å•"></a>ï¼ˆ1ï¼‰æ£€æŸ¥æ˜¯å¦ä¸€äººä¸€å•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;VoucherOrder&gt;()</span><br><span class="line">        .eq(VoucherOrder::getUserId, userId)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (count &gt;= <span class="number">1</span>) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ï¼ˆ2ï¼‰æ‰£å‡åº“å­˜ï¼ˆæ•°æ®åº“æ“ä½œï¼‰"><a href="#ï¼ˆ2ï¼‰æ‰£å‡åº“å­˜ï¼ˆæ•°æ®åº“æ“ä½œï¼‰" class="headerlink" title="ï¼ˆ2ï¼‰æ‰£å‡åº“å­˜ï¼ˆæ•°æ®åº“æ“ä½œï¼‰"></a>ï¼ˆ2ï¼‰æ‰£å‡åº“å­˜ï¼ˆæ•°æ®åº“æ“ä½œï¼‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">seckillVoucherService.update(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LambdaUpdateWrapper</span>&lt;SeckillVoucher&gt;()</span><br><span class="line">        .eq(SeckillVoucher::getVoucherId, voucherId)</span><br><span class="line">        .gt(SeckillVoucher::getStock, <span class="number">0</span>)</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä½¿ç”¨äº† <strong>ä¹è§‚é”</strong>ï¼š<code>gt(SeckillVoucher::getStock, 0)</code>ï¼Œä¿è¯åº“å­˜ä¸ä¼šå‡æˆè´Ÿæ•°ã€‚</p>
<hr>
<h3 id="ï¼ˆ3ï¼‰ä¿å­˜è®¢å•"><a href="#ï¼ˆ3ï¼‰ä¿å­˜è®¢å•" class="headerlink" title="ï¼ˆ3ï¼‰ä¿å­˜è®¢å•"></a>ï¼ˆ3ï¼‰ä¿å­˜è®¢å•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.save(voucherOrder);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-7-AOP-ä»£ç†å¯¹è±¡çš„ä½œç”¨"><a href="#2-7-AOP-ä»£ç†å¯¹è±¡çš„ä½œç”¨" class="headerlink" title="2.7. AOP ä»£ç†å¯¹è±¡çš„ä½œç”¨"></a>2.7. AOP ä»£ç†å¯¹è±¡çš„ä½œç”¨</h2><p>å…³é”®ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line"><span class="built_in">this</span>.proxy = proxy;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†ï¼Ÿ</p>
<p>ğŸ‘‰ åªæœ‰é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨äº‹åŠ¡æ–¹æ³•æ‰èƒ½è®© @Transactional ç”Ÿæ•ˆï¼ˆCGLIB æˆ– JDK ä»£ç†ï¼‰ã€‚</p>
<p>å› ä¸ºï¼š</p>
<ul>
<li>å†…éƒ¨è°ƒç”¨æ–¹æ³•ï¼ˆthis.createVoucherOrderï¼‰ä¸ä¼šè§¦å‘ AOP</li>
<li>æ‰€ä»¥äº‹åŠ¡ä¼šå¤±æ•ˆ</li>
</ul>
<p>æ‰€ä»¥ï¼š</p>
<ul>
<li>å…ˆæ‹¿åˆ°ä»£ç†å¯¹è±¡ä¿å­˜èµ·æ¥</li>
<li>ä»¥ååå°çº¿ç¨‹è°ƒç”¨ <code>proxy.createVoucherOrder()</code>ï¼Œäº‹åŠ¡æ‰èƒ½ç”Ÿæ•ˆ</li>
</ul>
<h2 id="3ã€é¡¹ç›®å¯åŠ¨æ—¶ã€‘æ‰§è¡Œçš„æµç¨‹ï¼ˆæœ€é‡è¦ï¼‰"><a href="#3ã€é¡¹ç›®å¯åŠ¨æ—¶ã€‘æ‰§è¡Œçš„æµç¨‹ï¼ˆæœ€é‡è¦ï¼‰" class="headerlink" title="3ã€é¡¹ç›®å¯åŠ¨æ—¶ã€‘æ‰§è¡Œçš„æµç¨‹ï¼ˆæœ€é‡è¦ï¼‰"></a>3ã€é¡¹ç›®å¯åŠ¨æ—¶ã€‘æ‰§è¡Œçš„æµç¨‹ï¼ˆæœ€é‡è¦ï¼‰</h2><p>å½“ Spring Boot å¯åŠ¨å¹¶åŠ è½½ Bean æ—¶ï¼Œä½ çš„æœåŠ¡ç±»ä¼šæŒ‰ä¸‹é¢é¡ºåºæ‰§è¡Œï¼š</p>
<hr>
<h3 id="ğŸŸ¦-3-1-1Spring-åˆ›å»º-VoucherOrderServiceImpl-Bean-å®ä¾‹"><a href="#ğŸŸ¦-3-1-1Spring-åˆ›å»º-VoucherOrderServiceImpl-Bean-å®ä¾‹" class="headerlink" title="ğŸŸ¦ 3.1. 1Spring åˆ›å»º VoucherOrderServiceImpl Bean å®ä¾‹"></a>ğŸŸ¦ <strong>3.1. 1Spring åˆ›å»º VoucherOrderServiceImpl Bean å®ä¾‹</strong></h3><p>Springæ‰«æåˆ° <code>@Service</code>ï¼Œåˆ›å»ºå®ä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class VoucherOrderServiceImpl extends ServiceImpl ...</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ­¥ä»…ä»…æ˜¯å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¹¶æ³¨å…¥ä¾èµ–ï¼š</p>
<ul>
<li>ISeckillVoucherService</li>
<li>RedisIdWorker</li>
<li>StringRedisTemplate</li>
<li>RedissonClient</li>
</ul>
<hr>
<h3 id="ğŸŸ¦-3-1-2-Spring-æ³¨å…¥è¢«-Resource-æ ‡æ³¨çš„å­—æ®µ"><a href="#ğŸŸ¦-3-1-2-Spring-æ³¨å…¥è¢«-Resource-æ ‡æ³¨çš„å­—æ®µ" class="headerlink" title="ğŸŸ¦ 3.1.2. Spring æ³¨å…¥è¢« @Resource æ ‡æ³¨çš„å­—æ®µ**"></a>ğŸŸ¦ 3.1.2. Spring æ³¨å…¥è¢« @Resource æ ‡æ³¨çš„å­—æ®µ**</h3><p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line">private ISeckillVoucherService seckillVoucherService;</span><br></pre></td></tr></table></figure>

<p>å…¨éƒ¨ä¾èµ–éƒ½è¢«æ³¨å…¥å¥½ã€‚</p>
<p>æ­¤æ—¶å¯¹è±¡å·²ç»å‡†å¤‡å¥½ï¼Œä½†è¿˜æ²¡è¿›å…¥ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚</p>
<hr>
<h3 id="ğŸŸ¦-3-1-3-Spring-AOP-åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆéå¸¸é‡è¦ï¼‰"><a href="#ğŸŸ¦-3-1-3-Spring-AOP-åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆéå¸¸é‡è¦ï¼‰" class="headerlink" title="ğŸŸ¦ 3.1.3 Spring AOP åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆéå¸¸é‡è¦ï¼‰"></a>ğŸŸ¦ <strong>3.1.3 Spring AOP åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆéå¸¸é‡è¦ï¼‰</strong></h3><p>å› ä¸ºä½ çš„ç±»å†…éƒ¨çš„æŸäº›æ–¹æ³•ç”¨åˆ°äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†è®©äº‹åŠ¡ç”Ÿæ•ˆï¼ŒSpring ä¼šç»™è¿™ä¸ª Bean åˆ›å»º AOP ä»£ç†ï¼ˆé€šå¸¸æ˜¯ CGLIBï¼‰ã€‚</p>
<p>æ­¤æ—¶ï¼š</p>
<ul>
<li>ä½ å¯¹ <code>this.xxx()</code> çš„ç›´æ¥è°ƒç”¨ <strong>ä¸ä¼šè§¦å‘äº‹åŠ¡</strong></li>
<li>åªæœ‰é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨æ‰ä¼šæœ‰äº‹åŠ¡</li>
</ul>
<p>è¿™ä¸ªåŸç†æ˜¯ä½ åé¢ç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AopContext.currentProxy();</span><br><span class="line">this.proxy = proxy;</span><br></pre></td></tr></table></figure>

<p>çš„åŸå› ã€‚</p>
<hr>
<h3 id="ğŸŸ¦-3-1-4-è°ƒç”¨-PostConstruct-çš„-init-æ–¹æ³•"><a href="#ğŸŸ¦-3-1-4-è°ƒç”¨-PostConstruct-çš„-init-æ–¹æ³•" class="headerlink" title="ğŸŸ¦ 3.1.4. è°ƒç”¨ @PostConstruct çš„ init() æ–¹æ³•"></a>ğŸŸ¦ <strong>3.1.4. è°ƒç”¨ @PostConstruct çš„ init() æ–¹æ³•</strong></h3><p>å¯åŠ¨åå°çº¿ç¨‹çš„é€»è¾‘å°±åœ¨è¿™é‡Œæ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@PostConstruct</span><br><span class="line">private void init() &#123;</span><br><span class="line">    SECKILL_ORDER_EXECUTOR.submit(new VoucherOrderHandler());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ“Œ <strong>è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ Bean åˆ›å»ºå®Œæˆ + ä¾èµ–æ³¨å…¥å®Œæˆ + AOP ä»£ç†åˆ›å»ºå®Œæˆåæ‰§è¡Œçš„</strong></p>
<p>è¿™ä¸€ç‚¹å¾ˆå…³é”®ï¼Œå› ä¸ºï¼š</p>
<h3 id="âœ”-æ­¤æ—¶æ‰€æœ‰ä¾èµ–éƒ½å¯ä»¥ä½¿ç”¨"><a href="#âœ”-æ­¤æ—¶æ‰€æœ‰ä¾èµ–éƒ½å¯ä»¥ä½¿ç”¨" class="headerlink" title="âœ” æ­¤æ—¶æ‰€æœ‰ä¾èµ–éƒ½å¯ä»¥ä½¿ç”¨"></a>âœ” æ­¤æ—¶æ‰€æœ‰ä¾èµ–éƒ½å¯ä»¥ä½¿ç”¨</h3><h3 id="âœ”-AOP-ä»£ç†ï¼ˆäº‹åŠ¡å¢å¼ºï¼‰ä¹Ÿå·²ç»å‡†å¤‡å¥½"><a href="#âœ”-AOP-ä»£ç†ï¼ˆäº‹åŠ¡å¢å¼ºï¼‰ä¹Ÿå·²ç»å‡†å¤‡å¥½" class="headerlink" title="âœ” AOP ä»£ç†ï¼ˆäº‹åŠ¡å¢å¼ºï¼‰ä¹Ÿå·²ç»å‡†å¤‡å¥½"></a>âœ” AOP ä»£ç†ï¼ˆäº‹åŠ¡å¢å¼ºï¼‰ä¹Ÿå·²ç»å‡†å¤‡å¥½</h3><h3 id="âœ”-æ‰€ä»¥å¯åŠ¨åå°çº¿ç¨‹æ˜¯å®‰å…¨çš„"><a href="#âœ”-æ‰€ä»¥å¯åŠ¨åå°çº¿ç¨‹æ˜¯å®‰å…¨çš„" class="headerlink" title="âœ” æ‰€ä»¥å¯åŠ¨åå°çº¿ç¨‹æ˜¯å®‰å…¨çš„"></a>âœ” æ‰€ä»¥å¯åŠ¨åå°çº¿ç¨‹æ˜¯å®‰å…¨çš„</h3><p>ç„¶åçº¿ç¨‹æ± å¼€å§‹è¿è¡Œ <code>VoucherOrderHandler</code>ã€‚</p>
<hr>
<h3 id="ğŸŸ¦-3-1-5-åå°çº¿ç¨‹å¼€å§‹è¿è¡Œï¼šVoucherOrderHandler-run"><a href="#ğŸŸ¦-3-1-5-åå°çº¿ç¨‹å¼€å§‹è¿è¡Œï¼šVoucherOrderHandler-run" class="headerlink" title="ğŸŸ¦ 3.1.5. åå°çº¿ç¨‹å¼€å§‹è¿è¡Œï¼šVoucherOrderHandler.run()"></a>ğŸŸ¦ <strong>3.1.5. åå°çº¿ç¨‹å¼€å§‹è¿è¡Œï¼šVoucherOrderHandler.run()</strong></h3><p>ä½ å¯åŠ¨çš„æ˜¯ä¸€ä¸ª <strong>æ°¸ä¸ç»“æŸçš„åå°çº¿ç¨‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è¯»å– Redis Stream çš„æ–°æ¶ˆæ¯</span></span><br><span class="line">        <span class="comment">// è½¬è®¢å•å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// åˆ›å»ºè®¢å•ï¼ˆåŠ é”ã€è°ƒç”¨ä»£ç†æ–¹æ³•ï¼‰</span></span><br><span class="line">        <span class="comment">// ACK</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        handlePendingList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»è¿™ä¸€åˆ»å¼€å§‹ï¼š</p>
<p>ğŸ‘‰ <strong>ä½ çš„ç¨‹åºå¼€å§‹æŒç»­ç›‘å¬ Redis Streamï¼Œç­‰å¾… Lua è„šæœ¬æ¨æ¥çš„è®¢å•æ¶ˆæ¯</strong></p>
<hr>
<h3 id="ğŸ¯-åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œã€é¡¹ç›®åˆšå¯åŠ¨æ—¶æ‰§è¡Œçš„é¡ºåºã€‘å®Œæˆï¼š"><a href="#ğŸ¯-åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œã€é¡¹ç›®åˆšå¯åŠ¨æ—¶æ‰§è¡Œçš„é¡ºåºã€‘å®Œæˆï¼š" class="headerlink" title="ğŸ¯ åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œã€é¡¹ç›®åˆšå¯åŠ¨æ—¶æ‰§è¡Œçš„é¡ºåºã€‘å®Œæˆï¼š"></a>ğŸ¯ åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œã€é¡¹ç›®åˆšå¯åŠ¨æ—¶æ‰§è¡Œçš„é¡ºåºã€‘å®Œæˆï¼š</h3><h3 id="ã€æœ€ç»ˆå¯åŠ¨é¡ºåºæ€»ç»“ã€‘"><a href="#ã€æœ€ç»ˆå¯åŠ¨é¡ºåºæ€»ç»“ã€‘" class="headerlink" title="ã€æœ€ç»ˆå¯åŠ¨é¡ºåºæ€»ç»“ã€‘"></a>ã€æœ€ç»ˆå¯åŠ¨é¡ºåºæ€»ç»“ã€‘</h3><ol>
<li>Spring åˆ›å»º VoucherOrderServiceImpl å®ä¾‹</li>
<li>æ³¨å…¥ @Resource çš„ä¾èµ–</li>
<li>åˆ›å»º Spring AOP ä»£ç†ï¼ˆå¢å¼º @Transactionalï¼‰</li>
<li>æ‰§è¡Œ @PostConstruct â†’ å¯åŠ¨å•çº¿ç¨‹ç›‘å¬ Redis Stream</li>
<li>æ–°çº¿ç¨‹è¿›å…¥ while(true) æ— é™å¾ªç¯ç­‰å¾…æ¶ˆæ¯</li>
</ol>
<hr>
<h3 id="ğŸ¯-3-2ã€ã€ç”¨æˆ·è¯·æ±‚ç§’æ€æ¥å£æ—¶ã€‘æ‰§è¡Œçš„é¡ºåº"><a href="#ğŸ¯-3-2ã€ã€ç”¨æˆ·è¯·æ±‚ç§’æ€æ¥å£æ—¶ã€‘æ‰§è¡Œçš„é¡ºåº" class="headerlink" title="ğŸ¯ 3.2ã€ã€ç”¨æˆ·è¯·æ±‚ç§’æ€æ¥å£æ—¶ã€‘æ‰§è¡Œçš„é¡ºåº"></a>ğŸ¯ 3.2ã€ã€ç”¨æˆ·è¯·æ±‚ç§’æ€æ¥å£æ—¶ã€‘æ‰§è¡Œçš„é¡ºåº</h3><p>ç”¨æˆ·è°ƒç”¨æ¥å£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public Result seckillVoucher(Long voucherId)</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</p>
<hr>
<h3 id="ğŸŸ¦-1-è·å–-userIdã€orderId"><a href="#ğŸŸ¦-1-è·å–-userIdã€orderId" class="headerlink" title="ğŸŸ¦ 1. è·å– userIdã€orderId"></a>ğŸŸ¦ <strong>1. è·å– userIdã€orderId</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Long userId = UserHolder.getUser().getId();</span><br><span class="line">long orderId = redisIdWorker.nextId(...);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸŸ¦-2-æ‰§è¡Œ-Lua-è„šæœ¬æ£€æŸ¥ç§’æ€èµ„æ ¼"><a href="#ğŸŸ¦-2-æ‰§è¡Œ-Lua-è„šæœ¬æ£€æŸ¥ç§’æ€èµ„æ ¼" class="headerlink" title="ğŸŸ¦ 2. æ‰§è¡Œ Lua è„šæœ¬æ£€æŸ¥ç§’æ€èµ„æ ¼"></a>ğŸŸ¦ <strong>2. æ‰§è¡Œ Lua è„šæœ¬æ£€æŸ¥ç§’æ€èµ„æ ¼</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.execute(SECKILL_SCRIPT, ...);</span><br></pre></td></tr></table></figure>

<p>Lua è„šæœ¬ä¼šå®Œæˆï¼š</p>
<ul>
<li>åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ</li>
<li>åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•</li>
<li>ç»™åº“å­˜ -1ï¼ˆRedis å†…å­˜å±‚ï¼‰</li>
<li>å†™å…¥ Redis Streamï¼š<code>XADD stream.orders * ...</code></li>
</ul>
<p>å¦‚æœè„šæœ¬è¿”å› 1 æˆ– 2ï¼Œè¯´æ˜å¤±è´¥ã€‚</p>
<p>å¦‚æœè¿”å› 0ï¼š</p>
<p>ğŸ‘‰ æ„å‘³ç€è®¢å•å†™å…¥äº† Redis Streamï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚</p>
<hr>
<h3 id="ğŸŸ¦-3-è·å–-AOP-ä»£ç†å¯¹è±¡"><a href="#ğŸŸ¦-3-è·å–-AOP-ä»£ç†å¯¹è±¡" class="headerlink" title="ğŸŸ¦ 3. è·å– AOP ä»£ç†å¯¹è±¡"></a>ğŸŸ¦ <strong>3. è·å– AOP ä»£ç†å¯¹è±¡</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IVoucherOrderService proxy = </span><br><span class="line">    (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">this.proxy = proxy;</span><br></pre></td></tr></table></figure>

<p>å¿…é¡»è¦ä»£ç†å¯¹è±¡æ¥æ‰§è¡Œäº‹åŠ¡æ–¹æ³• createVoucherOrderã€‚</p>
<p>ï¼ˆæ³¨æ„ï¼šcreateVoucherOrder å¹¶ä¸ä¼šåœ¨è¿™é‡Œæ‰§è¡Œï¼ï¼‰</p>
<hr>
<h3 id="ğŸŸ¦-4-ç›´æ¥-return-Result-ok"><a href="#ğŸŸ¦-4-ç›´æ¥-return-Result-ok" class="headerlink" title="ğŸŸ¦ 4. ç›´æ¥ return Result.ok()"></a>ğŸŸ¦ <strong>4. ç›´æ¥ return Result.ok()</strong></h3><p>å› ä¸ºä¸‹å•æ˜¯å¼‚æ­¥çš„ï¼Œè¿”å›ç»™ç”¨æˆ·çš„é€Ÿåº¦éå¸¸å¿«ã€‚</p>
<hr>
<h3 id="ğŸ¯3-3ã€åå°çº¿ç¨‹ç›‘å¬åˆ°æ¶ˆæ¯ã€‘æ‰§è¡Œé¡ºåº"><a href="#ğŸ¯3-3ã€åå°çº¿ç¨‹ç›‘å¬åˆ°æ¶ˆæ¯ã€‘æ‰§è¡Œé¡ºåº" class="headerlink" title="ğŸ¯3.3ã€åå°çº¿ç¨‹ç›‘å¬åˆ°æ¶ˆæ¯ã€‘æ‰§è¡Œé¡ºåº"></a>ğŸ¯3.3ã€åå°çº¿ç¨‹ç›‘å¬åˆ°æ¶ˆæ¯ã€‘æ‰§è¡Œé¡ºåº</h3><p>åå°çº¿ç¨‹ä¸æ–­æ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handleVoucherOrder(voucherOrder);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<hr>
<h3 id="ğŸŸ¦-1-Redis-Stream-æœ‰æ–°æ¶ˆæ¯ï¼Œçº¿ç¨‹è¯»å–å®ƒ"><a href="#ğŸŸ¦-1-Redis-Stream-æœ‰æ–°æ¶ˆæ¯ï¼Œçº¿ç¨‹è¯»å–å®ƒ" class="headerlink" title="ğŸŸ¦ 1. Redis Stream æœ‰æ–°æ¶ˆæ¯ï¼Œçº¿ç¨‹è¯»å–å®ƒ"></a>ğŸŸ¦ <strong>1. Redis Stream æœ‰æ–°æ¶ˆæ¯ï¼Œçº¿ç¨‹è¯»å–å®ƒ</strong></h3><p>ç”±åˆšæ‰ Lua è„šæœ¬å†™å…¥çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XADD stream.orders * userId=X voucherId=Y orderId=Z</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸŸ¦-2-è½¬ä¸º-Java-å¯¹è±¡-VoucherOrder"><a href="#ğŸŸ¦-2-è½¬ä¸º-Java-å¯¹è±¡-VoucherOrder" class="headerlink" title="ğŸŸ¦ 2. è½¬ä¸º Java å¯¹è±¡ VoucherOrder"></a>ğŸŸ¦ <strong>2. è½¬ä¸º Java å¯¹è±¡ VoucherOrder</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BeanUtil.fillBeanWithMap(...)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸŸ¦-3-åŠ -Redisson-åˆ†å¸ƒå¼é”ï¼ˆæŒ‰-userIdï¼‰"><a href="#ğŸŸ¦-3-åŠ -Redisson-åˆ†å¸ƒå¼é”ï¼ˆæŒ‰-userIdï¼‰" class="headerlink" title="ğŸŸ¦ 3. åŠ  Redisson åˆ†å¸ƒå¼é”ï¼ˆæŒ‰ userIdï¼‰"></a>ğŸŸ¦ <strong>3. åŠ  Redisson åˆ†å¸ƒå¼é”ï¼ˆæŒ‰ userIdï¼‰</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RLock lock = redissonClient.getLock(&quot;lock:order:&quot;+userId);</span><br></pre></td></tr></table></figure>

<p>ç¡®ä¿â€œä¸€äººä¸€å•â€ã€‚</p>
<hr>
<h3 id="ğŸŸ¦-4-è°ƒç”¨ä»£ç†å¯¹è±¡æ–¹æ³•åˆ›å»ºè®¢å•"><a href="#ğŸŸ¦-4-è°ƒç”¨ä»£ç†å¯¹è±¡æ–¹æ³•åˆ›å»ºè®¢å•" class="headerlink" title="ğŸŸ¦ 4. è°ƒç”¨ä»£ç†å¯¹è±¡æ–¹æ³•åˆ›å»ºè®¢å•"></a>ğŸŸ¦ <strong>4. è°ƒç”¨ä»£ç†å¯¹è±¡æ–¹æ³•åˆ›å»ºè®¢å•</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy.createVoucherOrder(voucherOrder);</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•æœ‰ï¼š</p>
<ul>
<li>æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•ï¼ˆæ•°æ®åº“ï¼‰</li>
<li>æ‰£åº“å­˜ï¼ˆæ•°æ®åº“ï¼‰</li>
<li>ä¿å­˜è®¢å•ï¼ˆæ•°æ®åº“ï¼‰</li>
<li>å…¨ç¨‹åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œ</li>
</ul>
<hr>
<h3 id="ğŸŸ¦-5-æ‰§è¡ŒæˆåŠŸå-ACK-Redis-Stream-æ¶ˆæ¯"><a href="#ğŸŸ¦-5-æ‰§è¡ŒæˆåŠŸå-ACK-Redis-Stream-æ¶ˆæ¯" class="headerlink" title="ğŸŸ¦ 5. æ‰§è¡ŒæˆåŠŸå ACK Redis Stream æ¶ˆæ¯"></a>ğŸŸ¦ <strong>5. æ‰§è¡ŒæˆåŠŸå ACK Redis Stream æ¶ˆæ¯</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XACK stream.orders g1 messageId</span><br></pre></td></tr></table></figure>

<h2 id="4-luaè„šæœ¬è¯­æ³•"><a href="#4-luaè„šæœ¬è¯­æ³•" class="headerlink" title="4.luaè„šæœ¬è¯­æ³•"></a>4.luaè„šæœ¬è¯­æ³•</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>];</span><br><span class="line"><span class="comment">-- ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>];</span><br><span class="line"><span class="comment">-- è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åº“å­˜çš„key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId;</span><br><span class="line"><span class="comment">-- è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey &gt; 0 ?</span></span><br><span class="line"><span class="keyword">local</span> stock = redis.call(<span class="string">&#x27;GET&#x27;</span>, stockKey);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(stock) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- åº“å­˜ä¸è¶³</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åº“å­˜å……è¶³ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹è¿‡å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;SISMEMBER&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- ç”¨æˆ·ä¸‹è¿‡å•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åº“å­˜å……è¶³ï¼Œæ²¡æœ‰ä¸‹è¿‡å•ï¼Œæ‰£åº“å­˜ã€ä¸‹å•</span></span><br><span class="line">redis.call(<span class="string">&#x27;INCRBY&#x27;</span>, stockKey, <span class="number">-1</span>);</span><br><span class="line">redis.call(<span class="string">&#x27;SADD&#x27;</span>, orderKey, userId);</span><br><span class="line"><span class="comment">-- å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼ŒXADD stream.orders * key1 value1 key2 value2...</span></span><br><span class="line">redis.call(<span class="string">&#x27;XADD&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId);</span><br><span class="line"><span class="comment">-- è¿”å›0ï¼Œè¡¨ç¤ºä¸‹å•æˆåŠŸ</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-1ARGV-æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå‚æ•°ä¼ è¿›-Lua-çš„æ–¹å¼ï¼‰"><a href="#4-1ARGV-æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå‚æ•°ä¼ è¿›-Lua-çš„æ–¹å¼ï¼‰" class="headerlink" title="4.1ARGV æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå‚æ•°ä¼ è¿› Lua çš„æ–¹å¼ï¼‰"></a>4.1ARGV æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå‚æ•°ä¼ è¿› Lua çš„æ–¹å¼ï¼‰</h3><h3 id="local-voucherId-ARGV-1"><a href="#local-voucherId-ARGV-1" class="headerlink" title="local voucherId = ARGV[1];"></a><code>local voucherId = ARGV[1];</code></h3><ul>
<li><p><code>ARGV</code> æ˜¯ Redis åœ¨æ‰§è¡Œ Lua è„šæœ¬æ—¶ï¼Œä¼ è¿›æ¥çš„ <strong>å‚æ•°æ•°ç»„</strong>ã€‚</p>
</li>
<li><p>ä½ åœ¨ Java é‡Œæ‰§è¡Œè„šæœ¬æ—¶å†™çš„æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.execute(</span><br><span class="line">    SECKILL_SCRIPT,</span><br><span class="line">    Collections.emptyList(), // KEYSï¼ˆè¿™é‡Œæ²¡ç”¨ï¼‰</span><br><span class="line">    voucherId.toString(),</span><br><span class="line">    userId.toString(),</span><br><span class="line">    String.valueOf(orderId)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”å…³ç³»æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ARGV[1] = voucherId</span><br><span class="line">ARGV[2] = userId</span><br><span class="line">ARGV[3] = orderId</span><br></pre></td></tr></table></figure></li>
</ul>
<p>æ‰€ä»¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">local voucherId = ARGV[1];</span><br><span class="line">local userId = ARGV[2];</span><br><span class="line">local orderId = ARGV[3];</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯æŠŠä¼ è¿›æ¥çš„å‚æ•°å–å‡ºæ¥ï¼Œèµ‹å€¼æˆå±€éƒ¨å˜é‡ã€‚</p>
<hr>
<h3 id="4-2æ‹¼æ¥-Redis-çš„-key"><a href="#4-2æ‹¼æ¥-Redis-çš„-key" class="headerlink" title="4.2æ‹¼æ¥ Redis çš„ key"></a>4.2æ‹¼æ¥ Redis çš„ key</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local stockKey = &#x27;seckill:stock:&#x27; .. voucherId;</span><br><span class="line">local orderKey = &#x27;seckill:order:&#x27; .. voucherId;</span><br></pre></td></tr></table></figure>

<h3 id="è¿™é‡Œçš„è¯­æ³•ç‚¹ï¼š"><a href="#è¿™é‡Œçš„è¯­æ³•ç‚¹ï¼š" class="headerlink" title="è¿™é‡Œçš„è¯­æ³•ç‚¹ï¼š"></a>è¿™é‡Œçš„è¯­æ³•ç‚¹ï¼š</h3><ul>
<li><p><code>&#39;å­—ç¬¦ä¸²&#39; .. å˜é‡</code>ï¼šLua ä¸­çš„å­—ç¬¦ä¸²æ‹¼æ¥è¿ç®—ç¬¦æ˜¯ <code>..</code></p>
</li>
<li><p>æ¯”å¦‚ <code>voucherId = 5</code> æ—¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stockKey = &quot;seckill:stock:5&quot;</span><br><span class="line">orderKey = &quot;seckill:order:5&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>è¿™äº›å°±æ˜¯ Redis é‡ŒçœŸå®ä½¿ç”¨çš„ key åï¼š</p>
<ul>
<li><code>seckill:stock:5</code>ï¼šå­˜è¿™ä¸ªä¼˜æƒ åˆ¸çš„åº“å­˜ï¼ˆString ç±»å‹ï¼‰</li>
<li><code>seckill:order:5</code>ï¼šå­˜è¿™å¼ åˆ¸å·²ç»ä¸‹è¿‡å•çš„ç”¨æˆ·ï¼ˆSet é›†åˆï¼‰</li>
</ul>
<hr>
<h3 id="4-3redis-call-æ˜¯å¹²å˜›çš„ï¼Ÿ"><a href="#4-3redis-call-æ˜¯å¹²å˜›çš„ï¼Ÿ" class="headerlink" title="4.3redis.call æ˜¯å¹²å˜›çš„ï¼Ÿ"></a>4.3redis.call æ˜¯å¹²å˜›çš„ï¼Ÿ</h3><p>åœ¨ Lua è„šæœ¬é‡Œï¼Œ<strong>æ‰€æœ‰ Redis å‘½ä»¤éƒ½é€šè¿‡ <code>redis.call</code> æ¥è°ƒç”¨</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(&#x27;å‘½ä»¤å&#x27;, å‚æ•°1, å‚æ•°2, ...)</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚ï¼š</p>
<ul>
<li><code>redis.call(&#39;GET&#39;, stockKey)</code></li>
<li><code>redis.call(&#39;SISMEMBER&#39;, orderKey, userId)</code></li>
<li><code>redis.call(&#39;XADD&#39;, &#39;stream.orders&#39;, &#39;*&#39;, &#39;userId&#39;, userId, ...)</code></li>
</ul>
<p>å¯ä»¥ç†è§£ä¸ºåœ¨ Lua é‡Œâ€œç›´æ¥æ‰§è¡Œ Redis å‘½ä»¤â€çš„è¯­æ³•ã€‚</p>
<hr>
<h3 id="4-4GETï¼šè¯»å–åº“å­˜"><a href="#4-4GETï¼šè¯»å–åº“å­˜" class="headerlink" title="4.4GETï¼šè¯»å–åº“å­˜"></a>4.4GETï¼šè¯»å–åº“å­˜</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local stock = redis.call(&#x27;GET&#x27;, stockKey);</span><br></pre></td></tr></table></figure>

<h3 id="Redis-åŸç”Ÿå‘½ä»¤ï¼š"><a href="#Redis-åŸç”Ÿå‘½ä»¤ï¼š" class="headerlink" title="Redis åŸç”Ÿå‘½ä»¤ï¼š"></a>Redis åŸç”Ÿå‘½ä»¤ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET key</span><br></pre></td></tr></table></figure>

<p>ä½œç”¨ï¼š</p>
<ul>
<li>ä» Redis è¯»å–ä¸€ä¸ª <strong>å­—ç¬¦ä¸²ç±»å‹</strong> çš„å€¼</li>
</ul>
<p>è¿™é‡Œï¼š</p>
<ul>
<li><code>stockKey</code> å°±æ˜¯ <code>&#39;seckill:stock:&#39; .. voucherId</code></li>
<li>å‡è®¾æ˜¯ <code>&quot;seckill:stock:5&quot;</code>ï¼Œå€¼å¯èƒ½æ˜¯ <code>&quot;10&quot;</code></li>
</ul>
<p><code>redis.call(&#39;GET&#39;, stockKey)</code> è¿”å›çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ <code>&quot;10&quot;</code>ã€‚<br> Lua é‡Œç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tonumber(stock)</span><br></pre></td></tr></table></figure>

<p>æŠŠå®ƒè½¬æˆæ•°å­—ï¼Œæ–¹ä¾¿æ¯”è¾ƒå¤§å°ã€‚</p>
<hr>
<h3 id="4-5åˆ¤æ–­åº“å­˜æ˜¯å¦"><a href="#4-5åˆ¤æ–­åº“å­˜æ˜¯å¦" class="headerlink" title="4.5åˆ¤æ–­åº“å­˜æ˜¯å¦ &lt;&#x3D; 0"></a>4.5åˆ¤æ–­åº“å­˜æ˜¯å¦ &lt;&#x3D; 0</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(stock) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è§£é‡Šï¼š</p>
<ul>
<li><code>tonumber(stock)</code>ï¼šæŠŠ GET åˆ°çš„å­—ç¬¦ä¸² <code>&quot;10&quot;</code> è½¬æˆæ•°å­— <code>10</code></li>
<li><code>&lt;= 0</code>ï¼šå¦‚æœæ˜¯ 0 æˆ–è´Ÿæ•°ï¼Œè¯´æ˜ <strong>æ²¡æœ‰åº“å­˜äº†</strong></li>
<li><code>return 1</code>ï¼šLua è„šæœ¬è¿”å› <code>1</code> ä»£è¡¨ â€œåº“å­˜ä¸è¶³â€</li>
</ul>
<p>æ‰€ä»¥è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼š</p>
<blockquote>
<p>å¦‚æœåº“å­˜ &lt;&#x3D; 0ï¼Œåˆ™æå‰ç»“æŸè„šæœ¬ï¼Œè¿”å› 1ã€‚</p>
</blockquote>
<hr>
<h3 id="4-6SISMEMBERï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹è¿‡å•"><a href="#4-6SISMEMBERï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹è¿‡å•" class="headerlink" title="4.6SISMEMBERï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹è¿‡å•"></a>4.6SISMEMBERï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹è¿‡å•</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;SISMEMBER&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Redis-åŸç”Ÿå‘½ä»¤ï¼š-1"><a href="#Redis-åŸç”Ÿå‘½ä»¤ï¼š-1" class="headerlink" title="Redis åŸç”Ÿå‘½ä»¤ï¼š"></a>Redis åŸç”Ÿå‘½ä»¤ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SISMEMBER key member</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šï¼š</p>
<ul>
<li>ç”¨äºåˆ¤æ–­ä¸€ä¸ªå€¼ <code>member</code> æ˜¯å¦åœ¨ <code>Set</code> é›†åˆ <code>key</code> é‡Œ</li>
<li>è¿”å›ï¼š<ul>
<li><code>1</code>ï¼šå­˜åœ¨</li>
<li><code>0</code>ï¼šä¸å­˜åœ¨</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œï¼š</p>
<ul>
<li><code>orderKey</code> &#x3D; <code>&quot;seckill:order:&lt;voucherId&gt;&quot;</code></li>
<li>è¿™ä¸ª key å¯¹åº”çš„æ˜¯ Redis çš„é›†åˆï¼ˆSetï¼‰ï¼Œé‡Œé¢å­˜çš„éƒ½æ˜¯å·²ç»ä¸‹è¿‡å•çš„ <code>userId</code></li>
<li><code>redis.call(&#39;SISMEMBER&#39;, orderKey, userId)</code>ï¼š<ul>
<li>å¦‚æœè¿™ä¸ªç”¨æˆ·ä¸‹è¿‡å• â†’ è¿”å› <code>1</code></li>
<li>æ²¡ä¸‹è¿‡å• â†’ è¿”å› <code>0</code></li>
</ul>
</li>
</ul>
<p>è„šæœ¬åˆ¤æ–­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">== 1  â†’ ä¸‹è¿‡å• â†’ return 2</span><br></pre></td></tr></table></figure>

<p><code>return 2</code> çš„å«ä¹‰ï¼š<strong>è¡¨ç¤ºç”¨æˆ·å·²ä¸‹å•ï¼Œä¸èƒ½é‡å¤æŠ¢</strong></p>
<hr>
<h3 id="4-7INCRBYï¼šæ‰£å‡åº“å­˜"><a href="#4-7INCRBYï¼šæ‰£å‡åº“å­˜" class="headerlink" title="4.7INCRBYï¼šæ‰£å‡åº“å­˜"></a>4.7INCRBYï¼šæ‰£å‡åº“å­˜</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;INCRBY&#x27;</span>, stockKey, <span class="number">-1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Redis-åŸç”Ÿå‘½ä»¤ï¼š-2"><a href="#Redis-åŸç”Ÿå‘½ä»¤ï¼š-2" class="headerlink" title="Redis åŸç”Ÿå‘½ä»¤ï¼š"></a>Redis åŸç”Ÿå‘½ä»¤ï¼š</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INCRBY key increment</span><br></pre></td></tr></table></figure>

<ul>
<li>å¢åŠ  key å¯¹åº”çš„æ•´æ•°å‹ value</li>
<li><code>increment</code> å¯ä»¥æ˜¯<strong>è´Ÿæ•°</strong> â†’ å®é™…å°±æ˜¯å‡æ³•</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET seckill:stock:<span class="number">5</span> <span class="number">10</span></span><br><span class="line">INCRBY seckill:stock:<span class="number">5</span> <span class="number">-1</span>  # ç»“æœå˜æˆ <span class="number">9</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ Lua ä¸­ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;INCRBY&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯ï¼š<strong>åº“å­˜ -1</strong>ã€‚<br> ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·ç”¨ï¼Ÿå› ä¸º Redis çš„ String ç±»å‹å¦‚æœå­˜çš„æ˜¯æ•°å­—å½¢å¼ï¼Œå¯ä»¥å½“æ•´æ•°è‡ªå¢è‡ªå‡ä½¿ç”¨ã€‚</p>
<hr>
<h3 id="4-8SADDï¼šæŠŠç”¨æˆ·åŠ å…¥å·²ä¸‹å•é›†åˆ"><a href="#4-8SADDï¼šæŠŠç”¨æˆ·åŠ å…¥å·²ä¸‹å•é›†åˆ" class="headerlink" title="4.8SADDï¼šæŠŠç”¨æˆ·åŠ å…¥å·²ä¸‹å•é›†åˆ"></a>4.8SADDï¼šæŠŠç”¨æˆ·åŠ å…¥å·²ä¸‹å•é›†åˆ</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;SADD&#x27;</span>, orderKey, userId);</span><br></pre></td></tr></table></figure>

<h3 id="Redis-åŸç”Ÿå‘½ä»¤ï¼š-3"><a href="#Redis-åŸç”Ÿå‘½ä»¤ï¼š-3" class="headerlink" title="Redis åŸç”Ÿå‘½ä»¤ï¼š"></a>Redis åŸç”Ÿå‘½ä»¤ï¼š</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SADD key member [member ...]</span><br></pre></td></tr></table></figure>

<p>å«ä¹‰ï¼š</p>
<ul>
<li>å‘é›†åˆï¼ˆSetï¼‰ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SADD seckill:order:<span class="number">5</span> <span class="number">1001</span></span><br></pre></td></tr></table></figure>

<ul>
<li>è¡¨ç¤ºç”¨æˆ· 1001 æŠ¢åˆ°äº†åˆ¸ 5</li>
<li>ä¹‹åå¯ä»¥é€šè¿‡ <code>SISMEMBER seckill:order:5 1001</code> åˆ¤æ–­æ˜¯å¦æŠ¢è¿‡</li>
</ul>
<p>åœ¨ä½ çš„è„šæœ¬é‡Œï¼š</p>
<ul>
<li><code>orderKey</code> &#x3D; <code>&quot;seckill:order:&quot; .. voucherId</code></li>
<li><code>userId</code> æ˜¯è¿™æ¬¡æ¥æŠ¢çš„ç”¨æˆ· ID</li>
</ul>
<p>æ‰€ä»¥è¿™ä¸€è¡Œè¡¨ç¤ºï¼š</p>
<blockquote>
<p><strong>è®°å½•ä¸‹è¿™ä¸ªç”¨æˆ·å·²ç»æŠ¢è¿‡è¿™å¼ åˆ¸ï¼Œç”¨æ¥å®ç°â€œä¸€äººä¸€å•â€ã€‚</strong></p>
</blockquote>
<hr>
<h3 id="4-9XADDï¼šæŠŠè®¢å•å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis-Streamï¼‰"><a href="#4-9XADDï¼šæŠŠè®¢å•å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis-Streamï¼‰" class="headerlink" title="4.9XADDï¼šæŠŠè®¢å•å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis Streamï¼‰"></a>4.9XADDï¼šæŠŠè®¢å•å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis Streamï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(&#x27;XADD&#x27;, &#x27;stream.orders&#x27;, &#x27;*&#x27;, &#x27;userId&#x27;, userId, &#x27;voucherId&#x27;, voucherId, &#x27;id&#x27;, orderId);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€è¡Œæ˜¯æ•´ä¸ªè„šæœ¬é‡Œæœ€å…³é”®çš„ä¸€å¥ï¼Œç”¨äº <strong>å‘é€æ¶ˆæ¯åˆ° Redis Stream é˜Ÿåˆ—</strong>ã€‚</p>
<h3 id="Redis-åŸç”Ÿå‘½ä»¤ï¼š-4"><a href="#Redis-åŸç”Ÿå‘½ä»¤ï¼š-4" class="headerlink" title="Redis åŸç”Ÿå‘½ä»¤ï¼š"></a>Redis åŸç”Ÿå‘½ä»¤ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XADD key message-id field1 value1 field2 value2 ...</span><br></pre></td></tr></table></figure>

<p>å‚æ•°è§£é‡Šï¼š</p>
<ul>
<li><code>key</code>ï¼šStream çš„åç§°ï¼Œæ¯”å¦‚ <code>&#39;stream.orders&#39;</code>ï¼ˆé˜Ÿåˆ—åï¼‰</li>
<li><code>message-id</code>ï¼š<ul>
<li><code>*</code>ï¼šè®© Redis è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé€’å¢çš„ IDï¼ˆå¦‚ <code>1691832948000-0</code>ï¼‰</li>
</ul>
</li>
<li><code>field1 value1</code>ï¼šæ¶ˆæ¯ä½“é‡Œçš„å†…å®¹ï¼ˆé”®å€¼å¯¹ï¼‰</li>
</ul>
<p>ä½ çš„è¿™æ¡å‘½ä»¤ç­‰ä»·äºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">XADD stream.orders * </span><br><span class="line">    userId    &lt;userId&gt; </span><br><span class="line">    voucherId &lt;voucherId&gt; </span><br><span class="line">    id        &lt;orderId&gt;</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XADD stream.orders * userId 1001 voucherId 5 id 88374290123</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯ï¼š</p>
<blockquote>
<p>å‘ <code>stream.orders</code> è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—é‡Œæ’å…¥ä¸€æ¡æ–°æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«ï¼š</p>
<ul>
<li>userId</li>
<li>voucherId</li>
<li>idï¼ˆè®¢å•idï¼‰</li>
</ul>
</blockquote>
<p>åé¢çš„ Java <strong>åå°çº¿ç¨‹</strong> å°±æ˜¯ä»è¿™ä¸ªé˜Ÿåˆ—é‡Œè¯»è¿™äº›æ¶ˆæ¯ï¼Œç„¶åçœŸæ­£å»å†™æ•°æ®åº“ä¸‹è®¢å•ã€‚</p>
<hr>
<h3 id="4-10return-0ï¼šè¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ"><a href="#4-10return-0ï¼šè¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ" class="headerlink" title="4.10return 0ï¼šè¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ"></a>4.10return 0ï¼šè¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return 0;</span><br></pre></td></tr></table></figure>

<p>å«ä¹‰å°±æ˜¯ï¼š</p>
<ul>
<li>å‰é¢åº“å­˜å……è¶³</li>
<li>ç”¨æˆ·ä¹Ÿæ²¡ä¸‹è¿‡å•</li>
<li>æˆåŠŸæ‰£äº† Redis é‡Œé¢„åº“å­˜</li>
<li>æˆåŠŸè®°å½•ç”¨æˆ·å·²æŠ¢è¿‡</li>
<li>æˆåŠŸå°†è®¢å•ä¿¡æ¯å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆStreamï¼‰</li>
</ul>
<p>æ‰€ä»¥è¿”å› <code>0</code> è¡¨ç¤º <strong>ä¸€åˆ‡æ­£å¸¸ï¼Œä¸‹å•æˆåŠŸï¼ˆå¼‚æ­¥åˆ›å»ºï¼‰</strong>ã€‚</p>
<p>ä½ çš„ Java é‡Œå¯¹åº”é€»è¾‘ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (result != null &amp;&amp; !result.equals(0L)) &#123;</span><br><span class="line">    // 1 = åº“å­˜ä¸è¶³, 2 = é‡å¤ä¸‹å•</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="âœ…-æ€»ç»“ä¸€ä¸‹æ¯ä¸ª-Redis-è¯­æ³•çš„ä½œç”¨"><a href="#âœ…-æ€»ç»“ä¸€ä¸‹æ¯ä¸ª-Redis-è¯­æ³•çš„ä½œç”¨" class="headerlink" title="âœ… æ€»ç»“ä¸€ä¸‹æ¯ä¸ª Redis è¯­æ³•çš„ä½œç”¨"></a>âœ… æ€»ç»“ä¸€ä¸‹æ¯ä¸ª Redis è¯­æ³•çš„ä½œç”¨</h3><p>æŒ‰é¡ºåºè®°ä¸€ä¸‹å°±å¥½ï¼š</p>
<ol>
<li><code>GET key</code><br> â†’ è¯»å–åº“å­˜å€¼ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ &gt; 0</li>
<li><code>SISMEMBER key member</code><br> â†’ åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»åœ¨â€œå·²ä¸‹å•ç”¨æˆ·é›†åˆâ€é‡Œï¼ˆæ˜¯å¦é‡å¤ä¸‹å•ï¼‰</li>
<li><code>INCRBY key -1</code><br> â†’ åº“å­˜å‡ 1ï¼ˆé¢„æ‰£åº“å­˜ï¼Œé˜²æ­¢è¶…å–ï¼‰</li>
<li><code>SADD key member</code><br> â†’ æŠŠå½“å‰ç”¨æˆ·åŠ å…¥â€œå·²ä¸‹å•ç”¨æˆ·é›†åˆâ€ï¼Œå®ç°ä¸€äººä¸€å•</li>
<li><code>XADD stream.orders * field value ...</code><br> â†’ æŠŠè®¢å•ä¿¡æ¯ï¼ˆuserIdã€voucherIdã€orderIdï¼‰å†™å…¥ Redis Stream é˜Ÿåˆ—ï¼Œä¾›åå°çº¿ç¨‹å¼‚æ­¥å¤„ç†</li>
<li><code>return 1 / 2 / 0</code><br> â†’ ä½œä¸ºè„šæœ¬æ‰§è¡Œç»“æœè¿”å›ç»™ Javaï¼Œç”¨äºåˆ¤æ–­ï¼š<ul>
<li>1ï¼šåº“å­˜ä¸è¶³</li>
<li>2ï¼šé‡å¤ä¸‹å•</li>
<li>0ï¼šæŠ¢è´­æˆåŠŸï¼Œå·²å…¥é˜Ÿç­‰å¾…å¼‚æ­¥å¤„ç†</li>
</ul>
</li>
</ol>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://example.com">chenjunda</a></p><p> <span>Link:  </span><a href="http://example.com/2025/11/27/redis%E5%AD%A6%E4%B9%A0Day4/">http://example.com/2025/11/27/redis%E5%AD%A6%E4%B9%A0Day4/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="nextSlogan" href="/2025/11/06/redis%E5%AD%A6%E4%B9%A0Day3/" title="rediså­¦ä¹ Day3"><span>NextPost ></span><br><span class="nextTitle">rediså­¦ä¹ Day3</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a target="_blank" rel="noopener" href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8redis%E4%B8%AD%E7%9A%84stream%E5%88%97%E8%A1%A8%E5%BD%93%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%BF%9B%E8%A1%8C%E5%BC%82%E6%AD%A5%E4%B8%8B%E5%8D%95"><span class="toc-number">1.</span> <span class="toc-text">ä½¿ç”¨redisä¸­çš„streamåˆ—è¡¨å½“æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥ä¸‹å•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8E%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">1. çº¿ç¨‹æ± ä¸åå°çº¿ç¨‹åˆå§‹åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%AD%90-1-1%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B%EF%BC%9F"><span class="toc-number">1.1.1.</span> <span class="toc-text">â­ 1. 1ç§’æ€ç³»ç»Ÿä¸ºä»€ä¹ˆè¦åå°çº¿ç¨‹ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%AD%90-1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%94%A8%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E7%BA%BF%E7%A8%8B%EF%BC%8C%E8%80%8C%E6%98%AF%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%9F"><span class="toc-number">1.1.2.</span> <span class="toc-text">â­ 1.2. ä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªæ™®é€šçº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨çº¿ç¨‹æ± ï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%94-1-2-1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9B%B4%E4%B8%93%E4%B8%9A%E3%80%81%E6%9B%B4%E5%AE%89%E5%85%A8"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">âœ” 1.2.1 çº¿ç¨‹æ± æ›´ä¸“ä¸šã€æ›´å®‰å…¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9D%8C-%E7%BA%BF%E7%A8%8B%E6%84%8F%E5%A4%96%E7%BB%93%E6%9D%9F%EF%BC%8C%E6%97%A0%E6%B3%95%E8%87%AA%E5%8A%A8%E6%81%A2%E5%A4%8D"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">âŒ çº¿ç¨‹æ„å¤–ç»“æŸï¼Œæ— æ³•è‡ªåŠ¨æ¢å¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%94-1-2-2-newSingleThreadExecutor-%E6%B0%B8%E4%B9%85%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%A4%84%E7%90%86%E8%AE%A2%E5%8D%95"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">âœ” 1.2.2 newSingleThreadExecutor() &#x3D; æ°¸ä¹…å•çº¿ç¨‹å¤„ç†è®¢å•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9%E4%B8%80%EF%BC%9A%E6%B0%B8%E8%BF%9C%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">ç‰¹ç‚¹ä¸€ï¼šæ°¸è¿œåªæœ‰ä¸€ä¸ªçº¿ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9%E4%BA%8C%EF%BC%9A%E7%BA%BF%E7%A8%8B%E6%8C%82%E4%BA%86%E4%BC%9A%E8%87%AA%E5%8A%A8%E6%8B%89%E8%B5%B7%E6%96%B0%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">ç‰¹ç‚¹äºŒï¼šçº¿ç¨‹æŒ‚äº†ä¼šè‡ªåŠ¨æ‹‰èµ·æ–°çº¿ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%AD%90-1-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%9F"><span class="toc-number">1.1.3.</span> <span class="toc-text">â­ 1.3. ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹çº¿ç¨‹æ± ï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%94-%E8%A6%81%E6%B1%82-1%EF%BC%9A%E9%A1%BA%E5%BA%8F%E5%A4%84%E7%90%86%E8%AE%A2%E5%8D%95"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">âœ” è¦æ±‚ 1ï¼šé¡ºåºå¤„ç†è®¢å•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%94-%E8%A6%81%E6%B1%82-2%EF%BC%9A%E9%98%B2%E6%AD%A2%E5%B9%B6%E5%8F%91%E6%89%A3%E5%BA%93%E5%AD%98%E3%80%81%E5%86%B2%E7%AA%81%E4%B8%8B%E5%8D%95"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">âœ” è¦æ±‚ 2ï¼šé˜²æ­¢å¹¶å‘æ‰£åº“å­˜ã€å†²çªä¸‹å•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%AD%90-1-4-newSingleThreadExecutor-%E4%B8%8E-new-Thread-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">1.1.4.</span> <span class="toc-text">â­ 1.4. newSingleThreadExecutor() ä¸ new Thread æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%AD%90-1-5-%E6%80%BB%E7%BB%93%EF%BC%88%E6%9C%80%E9%87%8D%E8%A6%81%EF%BC%8C%E9%9D%A2%E8%AF%95%E5%BF%85%E8%83%8C%EF%BC%89"><span class="toc-number">1.1.5.</span> <span class="toc-text">â­ 1.5. æ€»ç»“ï¼ˆæœ€é‡è¦ï¼Œé¢è¯•å¿…èƒŒï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-1-%E9%9C%80%E8%A6%81%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B%E9%95%BF%E6%9C%9F%E8%BF%90%E8%A1%8C%EF%BC%88%E9%9D%9E%E7%94%A8%E6%88%B7%E7%BA%BF%E7%A8%8B%EF%BC%89"><span class="toc-number">1.1.6.</span> <span class="toc-text">âœ” 1. éœ€è¦åå°çº¿ç¨‹é•¿æœŸè¿è¡Œï¼ˆéç”¨æˆ·çº¿ç¨‹ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-2-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%83%BD%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF%E7%BA%BF%E7%A8%8B%EF%BC%8C%E9%81%BF%E5%85%8D%E7%BA%BF%E7%A8%8B%E5%B4%A9%E6%BA%83%E5%AF%BC%E8%87%B4%E7%B3%BB%E7%BB%9F%E5%81%9C%E6%91%86"><span class="toc-number">1.1.7.</span> <span class="toc-text">âœ” 2. çº¿ç¨‹æ± èƒ½è‡ªåŠ¨é‡å¯çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹å´©æºƒå¯¼è‡´ç³»ç»Ÿåœæ‘†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-3-%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BF%9D%E8%AF%81%E8%AE%A2%E5%8D%95%E5%A4%84%E7%90%86%E5%AE%8C%E5%85%A8%E9%A1%BA%E5%BA%8F%EF%BC%8C%E9%81%BF%E5%85%8D%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.8.</span> <span class="toc-text">âœ” 3. å•çº¿ç¨‹æ± ä¿è¯è®¢å•å¤„ç†å®Œå…¨é¡ºåºï¼Œé¿å…å¹¶å‘é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-4-%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%EF%BC%8C%E8%AE%A2%E5%8D%95%E8%A6%81%E6%8E%92%E9%98%9F%E6%85%A2%E6%85%A2%E5%A4%84%E7%90%86%EF%BC%8C%E6%89%80%E4%BB%A5%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%9C%80%E5%90%88%E9%80%82"><span class="toc-number">1.1.9.</span> <span class="toc-text">âœ” 4. é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè®¢å•è¦æ’é˜Ÿæ…¢æ…¢å¤„ç†ï¼Œæ‰€ä»¥å•çº¿ç¨‹æœ€åˆé€‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-5-%E6%AF%94-new-Thread-%E6%9B%B4%E5%AE%89%E5%85%A8%E3%80%81%E6%9B%B4%E4%B8%93%E4%B8%9A%E3%80%81%E6%9B%B4%E4%B8%8D%E5%AE%B9%E6%98%93%E5%87%BA-bug"><span class="toc-number">1.1.10.</span> <span class="toc-text">âœ” 5. æ¯” new Thread æ›´å®‰å…¨ã€æ›´ä¸“ä¸šã€æ›´ä¸å®¹æ˜“å‡º bug</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Redis-Stream-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.2.</span> <span class="toc-text">2. Redis Stream æ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">è¯»å–æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E6%88%90-Java-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.2.</span> <span class="toc-text">è½¬æˆ Java å¯¹è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%AE%A2%E5%8D%95%E9%80%BB%E8%BE%91-ACK"><span class="toc-number">1.2.3.</span> <span class="toc-text">æ‰§è¡Œè®¢å•é€»è¾‘ &amp; ACK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1%E5%85%88%E7%9C%8B%E8%BF%99%E4%B8%80%E6%AE%B5-Java-%E4%BB%A3%E7%A0%81%E5%88%B0%E5%BA%95%E5%B9%B2%E4%BA%86%E5%95%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.1.1å…ˆçœ‹è¿™ä¸€æ®µ Java ä»£ç åˆ°åº•å¹²äº†å•¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-Consumer-from-%E2%80%9Cg1%E2%80%9D-%E2%80%9Cc1%E2%80%9D"><span class="toc-number">1.2.5.</span> <span class="toc-text">1ï¸âƒ£ Consumer.from(â€œg1â€, â€œc1â€)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-StreamReadOptions-empty-count-1-block-Duration-ofSeconds-1"><span class="toc-number">1.2.6.</span> <span class="toc-text">2ï¸âƒ£ StreamReadOptions.empty().count(1).block(Duration.ofSeconds(1))</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#count-1"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">count(1)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#block-Duration-ofSeconds-1"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">block(Duration.ofSeconds(1))</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-StreamOffset-create-queueName-ReadOffset-lastConsumed"><span class="toc-number">1.2.7.</span> <span class="toc-text">3ï¸âƒ£ StreamOffset.create(queueName, ReadOffset.lastConsumed())</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2%E6%8A%8A-Java-%E8%B0%83%E7%94%A8%E7%BF%BB%E8%AF%91%E6%88%90-Redis-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.8.</span> <span class="toc-text">2.1.2æŠŠ Java è°ƒç”¨ç¿»è¯‘æˆ Redis å‘½ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3%E8%AF%BB%E5%87%BA%E6%9D%A5%E5%90%8E%E8%BD%AC%E6%88%90-Java-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.9.</span> <span class="toc-text">2.1.3è¯»å‡ºæ¥åè½¬æˆ Java å¯¹è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-MapRecord-%E6%98%AF-Redis-Stream-%E7%9A%84%E6%B6%88%E6%81%AF%E5%B0%81%E8%A3%85"><span class="toc-number">1.2.10.</span> <span class="toc-text">1ï¸âƒ£ MapRecord æ˜¯ Redis Stream çš„æ¶ˆæ¯å°è£…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-BeanUtil-fillBeanWithMap-%E2%80%A6"><span class="toc-number">1.2.11.</span> <span class="toc-text">2ï¸âƒ£ BeanUtil.fillBeanWithMap(â€¦)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4%E6%89%A7%E8%A1%8C%E8%AE%A2%E5%8D%95%E9%80%BB%E8%BE%91-ACK"><span class="toc-number">1.2.12.</span> <span class="toc-text">2.1.4æ‰§è¡Œè®¢å•é€»è¾‘ + ACK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-handleVoucherOrder-voucherOrder"><span class="toc-number">1.2.13.</span> <span class="toc-text">1ï¸âƒ£ handleVoucherOrder(voucherOrder);</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-acknowledge-queueName-g1-record-getId"><span class="toc-number">1.2.14.</span> <span class="toc-text">2ï¸âƒ£ acknowledge(queueName, &quot;g1&quot;, record.getId())</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-5Redis-Stream-%E2%80%9C%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E2%80%9D-%E7%9A%84%E7%89%B9%E6%80%A7%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-number">1.2.15.</span> <span class="toc-text">2.1.5Redis Stream â€œæ¶ˆè´¹è€…ç»„â€ çš„ç‰¹æ€§ï¼ˆé‡ç‚¹ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%B8%8F%E2%83%A3-%E4%B8%80%E4%B8%AA-Stream%EF%BC%8C%E5%A4%9A%E7%BB%84%E6%B6%88%E8%B4%B9"><span class="toc-number">1.2.16.</span> <span class="toc-text">1ï¸âƒ£ ä¸€ä¸ª Streamï¼Œå¤šç»„æ¶ˆè´¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%B8%8F%E2%83%A3-%E7%BB%84%E5%86%85%E5%A4%9A%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.2.17.</span> <span class="toc-text">2ï¸âƒ£ ç»„å†…å¤šæ¶ˆè´¹è€…ï¼Œè´Ÿè½½å‡è¡¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%B8%8F%E2%83%A3-Pending-List%EF%BC%88%E6%9C%AA%E7%A1%AE%E8%AE%A4%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%EF%BC%89"><span class="toc-number">1.2.18.</span> <span class="toc-text">3ï¸âƒ£ Pending Listï¼ˆæœªç¡®è®¤æ¶ˆæ¯åˆ—è¡¨ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%B8%8F%E2%83%A3-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E8%AF%BB-PendingList-%E7%94%A8%E7%9A%84%E6%98%AF-offset-%E2%80%9C0%E2%80%9D"><span class="toc-number">1.2.19.</span> <span class="toc-text">4ï¸âƒ£ ä¸ºä»€ä¹ˆä½ è¯» PendingList ç”¨çš„æ˜¯ offset &#x3D; â€œ0â€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E6%96%B0%E6%B6%88%E6%81%AF%E7%94%A8%EF%BC%9A"><span class="toc-number">1.2.19.1.</span> <span class="toc-text">è¯»æ–°æ¶ˆæ¯ç”¨ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB-PendingList-%E7%94%A8%EF%BC%9A"><span class="toc-number">1.2.19.2.</span> <span class="toc-text">è¯» PendingList ç”¨ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%B8%8F%E2%83%A3-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84%E7%9A%84%E5%87%A0%E4%B8%AA%E5%85%B3%E9%94%AE%E5%A5%BD%E5%A4%84"><span class="toc-number">1.2.20.</span> <span class="toc-text">5ï¸âƒ£ æ¶ˆè´¹è€…ç»„çš„å‡ ä¸ªå…³é”®å¥½å¤„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-6%E6%8A%8A%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%86%8D%E4%B8%B2%E4%B8%80%E4%B8%8B%EF%BC%88%E7%BB%93%E5%90%88%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%89"><span class="toc-number">1.2.21.</span> <span class="toc-text">2.1.6æŠŠæ•´ä½“æµç¨‹å†ä¸²ä¸€ä¸‹ï¼ˆç»“åˆä½ çš„ä»£ç ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Pending-List-%E5%BC%82%E5%B8%B8%E8%A1%A5%E5%81%BF"><span class="toc-number">1.3.</span> <span class="toc-text">2.3. Pending List å¼‚å¸¸è¡¥å¿</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E5%89%8D%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.4.</span> <span class="toc-text">2.4. åˆ›å»ºè®¢å•å‰çš„åˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-Lua-%E8%84%9A%E6%9C%AC%E5%88%A4%E6%96%AD%E4%B8%8B%E5%8D%95%E8%B5%84%E6%A0%BC%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">2.5. Lua è„šæœ¬åˆ¤æ–­ä¸‹å•èµ„æ ¼ï¼ˆæ ¸å¿ƒï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%EF%BC%88%E7%9C%9F%E6%AD%A3%E5%86%99%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89"><span class="toc-number">1.6.</span> <span class="toc-text">2.6. åˆ›å»ºè®¢å•ï¼ˆçœŸæ­£å†™æ•°æ®åº“ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95"><span class="toc-number">1.6.1.</span> <span class="toc-text">ï¼ˆ1ï¼‰æ£€æŸ¥æ˜¯å¦ä¸€äººä¸€å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%89%A3%E5%87%8F%E5%BA%93%E5%AD%98%EF%BC%88%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-number">1.6.2.</span> <span class="toc-text">ï¼ˆ2ï¼‰æ‰£å‡åº“å­˜ï¼ˆæ•°æ®åº“æ“ä½œï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E4%BF%9D%E5%AD%98%E8%AE%A2%E5%8D%95"><span class="toc-number">1.6.3.</span> <span class="toc-text">ï¼ˆ3ï¼‰ä¿å­˜è®¢å•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-AOP-%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.7.</span> <span class="toc-text">2.7. AOP ä»£ç†å¯¹è±¡çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%90%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%97%B6%E3%80%91%E6%89%A7%E8%A1%8C%E7%9A%84%E6%B5%81%E7%A8%8B%EF%BC%88%E6%9C%80%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">1.8.</span> <span class="toc-text">3ã€é¡¹ç›®å¯åŠ¨æ—¶ã€‘æ‰§è¡Œçš„æµç¨‹ï¼ˆæœ€é‡è¦ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3-1-1Spring-%E5%88%9B%E5%BB%BA-VoucherOrderServiceImpl-Bean-%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.8.1.</span> <span class="toc-text">ğŸŸ¦ 3.1. 1Spring åˆ›å»º VoucherOrderServiceImpl Bean å®ä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3-1-2-Spring-%E6%B3%A8%E5%85%A5%E8%A2%AB-Resource-%E6%A0%87%E6%B3%A8%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">1.8.2.</span> <span class="toc-text">ğŸŸ¦ 3.1.2. Spring æ³¨å…¥è¢« @Resource æ ‡æ³¨çš„å­—æ®µ**</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3-1-3-Spring-AOP-%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%EF%BC%88%E9%9D%9E%E5%B8%B8%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">1.8.3.</span> <span class="toc-text">ğŸŸ¦ 3.1.3 Spring AOP åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆéå¸¸é‡è¦ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3-1-4-%E8%B0%83%E7%94%A8-PostConstruct-%E7%9A%84-init-%E6%96%B9%E6%B3%95"><span class="toc-number">1.8.4.</span> <span class="toc-text">ğŸŸ¦ 3.1.4. è°ƒç”¨ @PostConstruct çš„ init() æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-%E6%AD%A4%E6%97%B6%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96%E9%83%BD%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8"><span class="toc-number">1.8.5.</span> <span class="toc-text">âœ” æ­¤æ—¶æ‰€æœ‰ä¾èµ–éƒ½å¯ä»¥ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-AOP-%E4%BB%A3%E7%90%86%EF%BC%88%E4%BA%8B%E5%8A%A1%E5%A2%9E%E5%BC%BA%EF%BC%89%E4%B9%9F%E5%B7%B2%E7%BB%8F%E5%87%86%E5%A4%87%E5%A5%BD"><span class="toc-number">1.8.6.</span> <span class="toc-text">âœ” AOP ä»£ç†ï¼ˆäº‹åŠ¡å¢å¼ºï¼‰ä¹Ÿå·²ç»å‡†å¤‡å¥½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%94-%E6%89%80%E4%BB%A5%E5%90%AF%E5%8A%A8%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B%E6%98%AF%E5%AE%89%E5%85%A8%E7%9A%84"><span class="toc-number">1.8.7.</span> <span class="toc-text">âœ” æ‰€ä»¥å¯åŠ¨åå°çº¿ç¨‹æ˜¯å®‰å…¨çš„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3-1-5-%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%A7%8B%E8%BF%90%E8%A1%8C%EF%BC%9AVoucherOrderHandler-run"><span class="toc-number">1.8.8.</span> <span class="toc-text">ğŸŸ¦ 3.1.5. åå°çº¿ç¨‹å¼€å§‹è¿è¡Œï¼šVoucherOrderHandler.run()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%88%B0%E8%BF%99%E9%87%8C%E4%B8%BA%E6%AD%A2%EF%BC%8C%E3%80%90%E9%A1%B9%E7%9B%AE%E5%88%9A%E5%90%AF%E5%8A%A8%E6%97%B6%E6%89%A7%E8%A1%8C%E7%9A%84%E9%A1%BA%E5%BA%8F%E3%80%91%E5%AE%8C%E6%88%90%EF%BC%9A"><span class="toc-number">1.8.9.</span> <span class="toc-text">ğŸ¯ åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œã€é¡¹ç›®åˆšå¯åŠ¨æ—¶æ‰§è¡Œçš„é¡ºåºã€‘å®Œæˆï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%80%90%E6%9C%80%E7%BB%88%E5%90%AF%E5%8A%A8%E9%A1%BA%E5%BA%8F%E6%80%BB%E7%BB%93%E3%80%91"><span class="toc-number">1.8.10.</span> <span class="toc-text">ã€æœ€ç»ˆå¯åŠ¨é¡ºåºæ€»ç»“ã€‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF-3-2%E3%80%81%E3%80%90%E7%94%A8%E6%88%B7%E8%AF%B7%E6%B1%82%E7%A7%92%E6%9D%80%E6%8E%A5%E5%8F%A3%E6%97%B6%E3%80%91%E6%89%A7%E8%A1%8C%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.8.11.</span> <span class="toc-text">ğŸ¯ 3.2ã€ã€ç”¨æˆ·è¯·æ±‚ç§’æ€æ¥å£æ—¶ã€‘æ‰§è¡Œçš„é¡ºåº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-1-%E8%8E%B7%E5%8F%96-userId%E3%80%81orderId"><span class="toc-number">1.8.12.</span> <span class="toc-text">ğŸŸ¦ 1. è·å– userIdã€orderId</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-2-%E6%89%A7%E8%A1%8C-Lua-%E8%84%9A%E6%9C%AC%E6%A3%80%E6%9F%A5%E7%A7%92%E6%9D%80%E8%B5%84%E6%A0%BC"><span class="toc-number">1.8.13.</span> <span class="toc-text">ğŸŸ¦ 2. æ‰§è¡Œ Lua è„šæœ¬æ£€æŸ¥ç§’æ€èµ„æ ¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3-%E8%8E%B7%E5%8F%96-AOP-%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.8.14.</span> <span class="toc-text">ğŸŸ¦ 3. è·å– AOP ä»£ç†å¯¹è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-4-%E7%9B%B4%E6%8E%A5-return-Result-ok"><span class="toc-number">1.8.15.</span> <span class="toc-text">ğŸŸ¦ 4. ç›´æ¥ return Result.ok()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%8E%AF3-3%E3%80%90%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B%E7%9B%91%E5%90%AC%E5%88%B0%E6%B6%88%E6%81%AF%E3%80%91%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.8.16.</span> <span class="toc-text">ğŸ¯3.3ã€åå°çº¿ç¨‹ç›‘å¬åˆ°æ¶ˆæ¯ã€‘æ‰§è¡Œé¡ºåº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-1-Redis-Stream-%E6%9C%89%E6%96%B0%E6%B6%88%E6%81%AF%EF%BC%8C%E7%BA%BF%E7%A8%8B%E8%AF%BB%E5%8F%96%E5%AE%83"><span class="toc-number">1.8.17.</span> <span class="toc-text">ğŸŸ¦ 1. Redis Stream æœ‰æ–°æ¶ˆæ¯ï¼Œçº¿ç¨‹è¯»å–å®ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-2-%E8%BD%AC%E4%B8%BA-Java-%E5%AF%B9%E8%B1%A1-VoucherOrder"><span class="toc-number">1.8.18.</span> <span class="toc-text">ğŸŸ¦ 2. è½¬ä¸º Java å¯¹è±¡ VoucherOrder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-3-%E5%8A%A0-Redisson-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%88%E6%8C%89-userId%EF%BC%89"><span class="toc-number">1.8.19.</span> <span class="toc-text">ğŸŸ¦ 3. åŠ  Redisson åˆ†å¸ƒå¼é”ï¼ˆæŒ‰ userIdï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-4-%E8%B0%83%E7%94%A8%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E6%96%B9%E6%B3%95%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95"><span class="toc-number">1.8.20.</span> <span class="toc-text">ğŸŸ¦ 4. è°ƒç”¨ä»£ç†å¯¹è±¡æ–¹æ³•åˆ›å»ºè®¢å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%9F%A6-5-%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F%E5%90%8E-ACK-Redis-Stream-%E6%B6%88%E6%81%AF"><span class="toc-number">1.8.21.</span> <span class="toc-text">ğŸŸ¦ 5. æ‰§è¡ŒæˆåŠŸå ACK Redis Stream æ¶ˆæ¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-lua%E8%84%9A%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.9.</span> <span class="toc-text">4.luaè„šæœ¬è¯­æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1ARGV-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%EF%BC%88%E5%8F%82%E6%95%B0%E4%BC%A0%E8%BF%9B-Lua-%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%89"><span class="toc-number">1.9.1.</span> <span class="toc-text">4.1ARGV æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå‚æ•°ä¼ è¿› Lua çš„æ–¹å¼ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#local-voucherId-ARGV-1"><span class="toc-number">1.9.2.</span> <span class="toc-text">local voucherId &#x3D; ARGV[1];</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E6%8B%BC%E6%8E%A5-Redis-%E7%9A%84-key"><span class="toc-number">1.9.3.</span> <span class="toc-text">4.2æ‹¼æ¥ Redis çš„ key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E9%87%8C%E7%9A%84%E8%AF%AD%E6%B3%95%E7%82%B9%EF%BC%9A"><span class="toc-number">1.9.4.</span> <span class="toc-text">è¿™é‡Œçš„è¯­æ³•ç‚¹ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3redis-call-%E6%98%AF%E5%B9%B2%E5%98%9B%E7%9A%84%EF%BC%9F"><span class="toc-number">1.9.5.</span> <span class="toc-text">4.3redis.call æ˜¯å¹²å˜›çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4GET%EF%BC%9A%E8%AF%BB%E5%8F%96%E5%BA%93%E5%AD%98"><span class="toc-number">1.9.6.</span> <span class="toc-text">4.4GETï¼šè¯»å–åº“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E5%8E%9F%E7%94%9F%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="toc-number">1.9.7.</span> <span class="toc-text">Redis åŸç”Ÿå‘½ä»¤ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5%E5%88%A4%E6%96%AD%E5%BA%93%E5%AD%98%E6%98%AF%E5%90%A6"><span class="toc-number">1.9.8.</span> <span class="toc-text">4.5åˆ¤æ–­åº“å­˜æ˜¯å¦ &lt;&#x3D; 0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6SISMEMBER%EF%BC%9A%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E4%B8%8B%E8%BF%87%E5%8D%95"><span class="toc-number">1.9.9.</span> <span class="toc-text">4.6SISMEMBERï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ä¸‹è¿‡å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E5%8E%9F%E7%94%9F%E5%91%BD%E4%BB%A4%EF%BC%9A-1"><span class="toc-number">1.9.10.</span> <span class="toc-text">Redis åŸç”Ÿå‘½ä»¤ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7INCRBY%EF%BC%9A%E6%89%A3%E5%87%8F%E5%BA%93%E5%AD%98"><span class="toc-number">1.9.11.</span> <span class="toc-text">4.7INCRBYï¼šæ‰£å‡åº“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E5%8E%9F%E7%94%9F%E5%91%BD%E4%BB%A4%EF%BC%9A-2"><span class="toc-number">1.9.12.</span> <span class="toc-text">Redis åŸç”Ÿå‘½ä»¤ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8SADD%EF%BC%9A%E6%8A%8A%E7%94%A8%E6%88%B7%E5%8A%A0%E5%85%A5%E5%B7%B2%E4%B8%8B%E5%8D%95%E9%9B%86%E5%90%88"><span class="toc-number">1.9.13.</span> <span class="toc-text">4.8SADDï¼šæŠŠç”¨æˆ·åŠ å…¥å·²ä¸‹å•é›†åˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E5%8E%9F%E7%94%9F%E5%91%BD%E4%BB%A4%EF%BC%9A-3"><span class="toc-number">1.9.14.</span> <span class="toc-text">Redis åŸç”Ÿå‘½ä»¤ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9XADD%EF%BC%9A%E6%8A%8A%E8%AE%A2%E5%8D%95%E5%86%99%E5%85%A5%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%88Redis-Stream%EF%BC%89"><span class="toc-number">1.9.15.</span> <span class="toc-text">4.9XADDï¼šæŠŠè®¢å•å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis Streamï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E5%8E%9F%E7%94%9F%E5%91%BD%E4%BB%A4%EF%BC%9A-4"><span class="toc-number">1.9.16.</span> <span class="toc-text">Redis åŸç”Ÿå‘½ä»¤ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-10return-0%EF%BC%9A%E8%A1%A8%E7%A4%BA%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F"><span class="toc-number">1.9.17.</span> <span class="toc-text">4.10return 0ï¼šè¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B%E6%AF%8F%E4%B8%AA-Redis-%E8%AF%AD%E6%B3%95%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.9.18.</span> <span class="toc-text">âœ… æ€»ç»“ä¸€ä¸‹æ¯ä¸ª Redis è¯­æ³•çš„ä½œç”¨</span></a></li></ol></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>